<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Profile | Game Logger</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link
        href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800&family=Space+Grotesk:wght@400;500;600;700&display=swap"
        rel="stylesheet">
    <style>
        :root {
            --primary: #8b5cf6;
            --primary-light: #a78bfa;
            --secondary: #ec4899;
            --accent: #06b6d4;
            --success: #10b981;
            --warning: #f59e0b;
            --dark: #0f0f14;
            --darker: #0a0a0e;
            --card: #16161d;
            --card-hover: #1e1e28;
        }

        * {
            font-family: 'Outfit', sans-serif;
        }

        body {
            background: linear-gradient(180deg, var(--darker) 0%, var(--dark) 50%, var(--darker) 100%);
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* ========== GAMERY EFFECTS ========== */

        /* Animated pulse for Now Playing */
        @keyframes pulse-glow {

            0%,
            100% {
                box-shadow: 0 0 5px rgba(16, 185, 129, 0.5), 0 0 10px rgba(16, 185, 129, 0.3);
            }

            50% {
                box-shadow: 0 0 15px rgba(16, 185, 129, 0.8), 0 0 25px rgba(16, 185, 129, 0.5);
            }
        }

        .now-playing-badge {
            animation: pulse-glow 2s ease-in-out infinite;
        }

        /* Neon glow on hover */
        @keyframes neon-flicker {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.8;
            }
        }

        .glow-hover:hover {
            box-shadow: 0 0 20px rgba(139, 92, 246, 0.4), 0 0 40px rgba(139, 92, 246, 0.2);
            transition: box-shadow 0.3s ease;
        }

        /* XP Bar */
        .xp-bar {
            height: 8px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
            overflow: hidden;
            position: relative;
        }

        .xp-bar-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary), var(--secondary), var(--accent));
            background-size: 200% 100%;
            animation: xp-shimmer 3s ease infinite;
            border-radius: 4px;
            transition: width 0.5s ease;
        }

        @keyframes xp-shimmer {
            0% {
                background-position: 0% 50%;
            }

            50% {
                background-position: 100% 50%;
            }

            100% {
                background-position: 0% 50%;
            }
        }

        /* Achievement Toast */
        .achievement-toast {
            position: fixed;
            bottom: 100px;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: linear-gradient(135deg, rgba(22, 22, 29, 0.98), rgba(30, 30, 40, 0.98));
            border: 2px solid transparent;
            background-origin: border-box;
            background-clip: padding-box, border-box;
            border-radius: 16px;
            padding: 16px 24px;
            display: flex;
            align-items: center;
            gap: 16px;
            z-index: 9999;
            opacity: 0;
            transition: all 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.5), 0 0 60px rgba(139, 92, 246, 0.3);
        }

        .achievement-toast.show {
            transform: translateX(-50%) translateY(0);
            opacity: 1;
        }

        .achievement-toast::before {
            content: '';
            position: absolute;
            inset: -2px;
            background: linear-gradient(135deg, var(--primary), var(--secondary), var(--accent));
            border-radius: 18px;
            z-index: -1;
            animation: border-glow 2s ease infinite;
        }

        @keyframes border-glow {

            0%,
            100% {
                opacity: 0.8;
            }

            50% {
                opacity: 1;
            }
        }

        .achievement-icon {
            width: 50px;
            height: 50px;
            border-radius: 12px;
            background: linear-gradient(135deg, var(--warning), #f97316);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            box-shadow: 0 0 20px rgba(245, 158, 11, 0.5);
        }

        /* Trophy Cabinet */
        .trophy-cabinet {
            background: linear-gradient(135deg, rgba(245, 158, 11, 0.05), rgba(234, 179, 8, 0.02));
            border: 1px solid rgba(245, 158, 11, 0.2);
            border-radius: 16px;
            padding: 20px;
        }

        .trophy-item {
            background: linear-gradient(135deg, rgba(245, 158, 11, 0.1), transparent);
            border: 1px solid rgba(245, 158, 11, 0.2);
            border-radius: 12px;
            padding: 12px;
            transition: all 0.3s;
        }

        .trophy-item:hover {
            transform: translateY(-4px) scale(1.02);
            box-shadow: 0 10px 30px rgba(245, 158, 11, 0.3);
            border-color: rgba(245, 158, 11, 0.5);
        }

        /* Health Bar Progress */
        .health-bar {
            height: 12px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 6px;
            overflow: hidden;
            position: relative;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .health-bar-fill {
            height: 100%;
            background: linear-gradient(90deg, #22c55e, #16a34a);
            box-shadow: inset 0 -2px 4px rgba(0, 0, 0, 0.2), 0 0 10px rgba(34, 197, 94, 0.5);
            transition: width 0.5s ease;
            position: relative;
        }

        .health-bar-fill::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 50%;
            background: linear-gradient(to bottom, rgba(255, 255, 255, 0.3), transparent);
        }

        /* Scanlines overlay (subtle) */
        .scanlines::after {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: repeating-linear-gradient(0deg,
                    transparent,
                    transparent 2px,
                    rgba(0, 0, 0, 0.03) 2px,
                    rgba(0, 0, 0, 0.03) 4px);
            pointer-events: none;
            z-index: 9998;
            opacity: 0.5;
        }

        /* Level badge */
        .level-badge {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            padding: 4px 12px;
            border-radius: 20px;
            font-weight: 700;
            font-size: 12px;
            box-shadow: 0 0 15px rgba(139, 92, 246, 0.4);
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
        }

        /* Icon wiggle on hover */
        @keyframes wiggle {

            0%,
            100% {
                transform: rotate(0deg);
            }

            25% {
                transform: rotate(-5deg);
            }

            75% {
                transform: rotate(5deg);
            }
        }

        .wiggle-hover:hover i {
            animation: wiggle 0.5s ease;
        }


        /* Fix dropdown options dark theme */
        select option {
            background: var(--card);
            color: white;
        }

        select optgroup {
            background: var(--darker);
            color: var(--primary-light);
        }

        .sidebar {
            width: 260px;
            background: rgba(22, 22, 29, 0.95);
            border-right: 1px solid rgba(139, 92, 246, 0.1);
            backdrop-filter: blur(20px);
        }

        .gradient-text {
            background: linear-gradient(135deg, var(--primary-light), var(--secondary), var(--accent));
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            font-weight: 700;
        }

        .gradient-border {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            padding: 2px;
            border-radius: 16px;
        }

        .nav-link {
            padding: 11px 16px;
            border-radius: 12px;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 14px;
            color: #71717a;
            font-weight: 500;
        }

        .nav-link:hover {
            background: rgba(139, 92, 246, 0.1);
            color: var(--primary-light);
        }

        .nav-link.active {
            background: linear-gradient(90deg, rgba(139, 92, 246, 0.15), transparent);
            color: var(--primary-light);
        }

        .stat-card {
            background: var(--card);
            border: 1px solid rgba(255, 255, 255, 0.06);
            border-radius: 16px;
            padding: 16px;
            text-align: center;
            transition: all 0.3s;
        }

        .stat-card:hover {
            background: var(--card-hover);
            border-color: rgba(139, 92, 246, 0.2);
        }

        .stat-card .text-xl {
            font-family: 'Space Grotesk', sans-serif;
            font-weight: 700;
            background: linear-gradient(135deg, var(--primary-light), var(--accent));
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .fav-card {
            width: 140px;
            height: 80px;
            border-radius: 12px;
            overflow: hidden;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            cursor: pointer;
            border: 2px solid transparent;
            background: linear-gradient(var(--card), var(--card)) padding-box,
                linear-gradient(135deg, var(--secondary), var(--primary)) border-box;
        }

        .fav-card:hover {
            transform: scale(1.05) rotate(1deg);
            box-shadow: 0 15px 30px -10px rgba(236, 72, 153, 0.4);
        }

        .fav-card.empty {
            background: linear-gradient(135deg, rgba(236, 72, 153, 0.08), rgba(139, 92, 246, 0.08));
            border: 2px dashed rgba(236, 72, 153, 0.3);
        }

        .fav-card.empty:hover {
            border-color: rgba(236, 72, 153, 0.6);
            box-shadow: 0 10px 30px -10px rgba(236, 72, 153, 0.3);
        }

        .club-card {
            border-radius: 12px;
            overflow: hidden;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            cursor: pointer;
            position: relative;
            border: 2px solid transparent;
            background: linear-gradient(var(--card), var(--card)) padding-box,
                linear-gradient(135deg, var(--warning), #f97316) border-box;
        }

        .club-card:hover {
            transform: scale(1.05) rotate(-1deg);
            box-shadow: 0 15px 30px -10px rgba(245, 158, 11, 0.4);
        }

        .club-card::after {
            content: '';
            position: absolute;
            inset: 0;
            background: linear-gradient(to top, rgba(0, 0, 0, 0.7), transparent);
        }

        .game-row {
            padding: 14px 16px;
            margin: 0 -16px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            gap: 16px;
            transition: all 0.2s;
            cursor: pointer;
            border-bottom: 1px solid rgba(255, 255, 255, 0.03);
        }

        .game-row:hover {
            background: linear-gradient(90deg, rgba(139, 92, 246, 0.08), transparent);
            border-color: transparent;
        }

        .status-badge {
            font-size: 10px;
            padding: 4px 10px;
            border-radius: 20px;
            font-weight: 600;
        }

        .status-backlog {
            background: rgba(82, 82, 91, 0.5);
            color: #a1a1aa;
        }

        .status-played {
            background: rgba(16, 185, 129, 0.2);
            color: #34d399;
            border: 1px solid rgba(16, 185, 129, 0.3);
        }

        .status-finished {
            background: rgba(59, 130, 246, 0.2);
            color: #60a5fa;
            border: 1px solid rgba(59, 130, 246, 0.3);
        }

        .status-perfected {
            background: linear-gradient(135deg, rgba(245, 158, 11, 0.25), rgba(249, 115, 22, 0.2));
            color: #fbbf24;
            border: 1px solid rgba(245, 158, 11, 0.4);
            animation: glow-pulse 2s infinite;
        }

        .status-endless {
            background: rgba(168, 85, 247, 0.2);
            color: #c084fc;
            border: 1px solid rgba(168, 85, 247, 0.3);
        }

        .status-dropped {
            background: rgba(239, 68, 68, 0.15);
            color: #f87171;
            border: 1px solid rgba(239, 68, 68, 0.2);
        }

        .status-on_hold {
            background: rgba(245, 158, 11, 0.15);
            color: #fbbf24;
            border: 1px solid rgba(245, 158, 11, 0.2);
        }

        .tab-btn {
            padding: 10px 20px;
            font-weight: 600;
            color: #6b7280;
            transition: all 0.2s;
            border-bottom: 2px solid transparent;
        }

        .tab-btn:hover {
            color: var(--primary-light);
        }

        .tab-btn.active {
            color: white;
            border-color: var(--primary);
        }

        .filter-pill {
            padding: 6px 14px;
            font-size: 12px;
            border-radius: 20px;
            transition: all 0.2s;
            color: #71717a;
        }

        .filter-pill:hover {
            background: rgba(139, 92, 246, 0.1);
            color: var(--primary-light);
        }

        .filter-pill.active {
            background: linear-gradient(135deg, rgba(139, 92, 246, 0.2), rgba(168, 85, 247, 0.15));
            color: white;
        }

        .modal-overlay {
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(8px);
        }

        .modal-card {
            background: var(--card);
            border: 1px solid rgba(139, 92, 246, 0.15);
            border-radius: 24px;
            overflow: hidden;
        }

        .ach-bar {
            height: 6px;
            border-radius: 6px;
            background: rgba(255, 255, 255, 0.1);
        }

        .ach-fill {
            height: 100%;
            border-radius: 6px;
            background: linear-gradient(90deg, var(--success), #34d399);
        }

        .ach-fill.gold {
            background: linear-gradient(90deg, var(--warning), #f97316);
        }

        .rating-group {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .rating-row {
            display: flex;
            align-items: center;
            gap: 14px;
        }

        .rating-row label {
            width: 70px;
            font-size: 12px;
            color: #71717a;
        }

        .rating-star {
            color: #27272a;
            cursor: pointer;
            transition: all 0.15s;
            font-size: 18px;
        }

        .rating-star.active {
            color: #fbbf24;
        }

        .rating-star:hover {
            color: #fcd34d;
            transform: scale(1.2);
        }

        .journal-entry {
            padding: 20px;
            background: var(--card);
            border: 1px solid rgba(255, 255, 255, 0.05);
            border-radius: 16px;
            margin-bottom: 16px;
            transition: all 0.2s;
        }

        .journal-entry:hover {
            border-color: rgba(139, 92, 246, 0.2);
            transform: translateX(4px);
        }

        .btn-glow {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            box-shadow: 0 8px 25px -8px rgba(139, 92, 246, 0.5);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            font-weight: 600;
            border: none;
            position: relative;
            overflow: hidden;
        }

        .btn-glow::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.5s;
        }

        .btn-glow:hover {
            box-shadow: 0 15px 35px -10px rgba(139, 92, 246, 0.6);
            transform: translateY(-2px);
        }

        .btn-glow:hover::before {
            left: 100%;
        }

        input,
        select,
        textarea {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 10px 14px;
            font-size: 14px;
            color: white;
            transition: all 0.2s;
        }

        input:focus,
        select:focus,
        textarea:focus {
            outline: none;
            border-color: rgba(139, 92, 246, 0.5);
            box-shadow: 0 0 0 3px rgba(139, 92, 246, 0.1);
        }

        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: linear-gradient(180deg, var(--primary), var(--secondary));
            border-radius: 10px;
        }

        /* Animations */
        @keyframes glow-pulse {

            0%,
            100% {
                box-shadow: 0 0 10px rgba(245, 158, 11, 0.3);
            }

            50% {
                box-shadow: 0 0 20px rgba(245, 158, 11, 0.5);
            }
        }

        @keyframes float {

            0%,
            100% {
                transform: translateY(0);
            }

            50% {
                transform: translateY(-8px);
            }
        }

        .float-animation {
            animation: float 3s ease-in-out infinite;
        }

        /* Interactive hover effects */
        .interactive-card {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .interactive-card:hover {
            transform: translateY(-4px);
        }

        /* === VIEW TOGGLE === */
        .view-toggle {
            display: flex;
            gap: 4px;
            background: rgba(255, 255, 255, 0.05);
            padding: 4px;
            border-radius: 10px;
        }

        .view-toggle-btn {
            padding: 6px 12px;
            border-radius: 8px;
            font-size: 12px;
            color: #71717a;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .view-toggle-btn:hover {
            color: white;
        }

        .view-toggle-btn.active {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
        }

        /* === GRID VIEW === */
        .games-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 20px;
        }

        .game-card {
            background: var(--card);
            border: 1px solid rgba(255, 255, 255, 0.06);
            border-radius: 16px;
            overflow: hidden;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            cursor: pointer;
            position: relative;
        }

        .game-card:hover {
            transform: translateY(-8px) scale(1.02);
            border-color: rgba(139, 92, 246, 0.3);
            box-shadow: 0 20px 40px -15px rgba(139, 92, 246, 0.4);
        }

        .game-card-img {
            height: 100px;
            width: 100%;
            object-fit: cover;
        }

        .game-card-body {
            padding: 14px;
        }

        .game-card-title {
            font-weight: 600;
            font-size: 14px;
            margin-bottom: 8px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .game-card-meta {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 11px;
            color: #71717a;
            margin-bottom: 10px;
        }

        .game-card-footer {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 8px;
        }

        /* === RECENT PLAYTIME BADGE === */
        .recent-playtime-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 3px 8px;
            font-size: 10px;
            font-weight: 600;
            color: #22c55e;
            background: rgba(34, 197, 94, 0.1);
            border: 1px solid rgba(34, 197, 94, 0.3);
            border-radius: 6px;
        }

        .recent-playtime-badge i {
            font-size: 8px;
        }

        /* === PROGRESS RING === */
        .progress-ring {
            width: 36px;
            height: 36px;
            position: relative;
        }

        .progress-ring svg {
            transform: rotate(-90deg);
        }

        .progress-ring circle {
            fill: none;
            stroke-width: 3;
        }

        .progress-ring .ring-bg {
            stroke: rgba(255, 255, 255, 0.1);
        }

        .progress-ring .ring-fill {
            stroke: var(--success);
            stroke-linecap: round;
            transition: stroke-dashoffset 0.6s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .progress-ring .ring-fill.gold {
            stroke: var(--warning);
        }

        .progress-ring-text {
            position: absolute;
            inset: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 9px;
            font-weight: 600;
            color: #a1a1aa;
        }

        /* === GAME LIST RATING STARS === */
        .game-rating-stars {
            display: flex;
            gap: 1px;
            font-size: 11px;
            background: linear-gradient(135deg, rgba(251, 191, 36, 0.1), rgba(245, 158, 11, 0.1));
            padding: 4px 8px;
            border-radius: 8px;
            border: 1px solid rgba(251, 191, 36, 0.2);
        }

        .game-rating-stars span {
            text-shadow: 0 0 8px rgba(251, 191, 36, 0.5);
        }

        /* === HALF-STAR RATING SYSTEM === */
        .half-star-container {
            display: inline-block;
            position: relative;
            width: 24px;
            height: 24px;
            font-size: 24px;
            cursor: pointer;
        }

        .half-star {
            position: absolute;
            top: 0;
            overflow: hidden;
            color: #3f3f46;
            transition: color 0.15s;
        }

        .half-star.left {
            left: 0;
            width: 50%;
        }

        .half-star.right {
            left: 0;
            width: 100%;
            z-index: -1;
        }

        .half-star.active {
            color: #fbbf24;
        }

        .half-star:hover {
            color: #fcd34d;
        }

        /* === GAME CATEGORY RATINGS === */
        .game-cat-rating {
            display: flex;
            gap: 2px;
        }

        .game-cat-rating .cat-star {
            font-size: 16px;
            cursor: pointer;
            color: #3f3f46;
            transition: color 0.15s;
            position: relative;
        }

        .game-cat-rating .cat-star.active {
            color: #fbbf24;
        }

        .game-cat-rating .cat-star.half {
            color: #fbbf24;
        }

        .game-cat-rating .cat-star:hover {
            color: #fcd34d;
        }

        .game-cat-rating.disabled {
            opacity: 0.3;
            pointer-events: none;
        }

        /* === QUICK ACTIONS OVERLAY === */
        .game-row {
            position: relative;
        }

        .quick-actions {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            opacity: 0;
            display: flex;
            gap: 4px;
            transition: all 0.2s;
            pointer-events: none;
            background: rgba(22, 22, 29, 0.95);
            padding: 4px;
            border-radius: 10px;
            border: 1px solid rgba(139, 92, 246, 0.3);
            backdrop-filter: blur(8px);
            z-index: 10;
        }

        .game-row:hover .quick-actions {
            opacity: 1;
            pointer-events: auto;
        }

        .quick-action-btn {
            width: 28px;
            height: 28px;
            border-radius: 8px;
            background: rgba(139, 92, 246, 0.2);
            color: var(--primary-light);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 11px;
            transition: all 0.2s;
        }

        .quick-action-btn:hover {
            background: var(--primary);
            color: white;
            transform: scale(1.1);
        }

        /* === RECENT SESSION BADGE === */
        .now-playing-badge {
            background: linear-gradient(135deg, var(--success), #059669);
            color: white;
            font-size: 9px;
            font-weight: 600;
            padding: 3px 8px;
            border-radius: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            animation: pulse-glow 2s infinite;
            box-shadow: 0 0 15px rgba(16, 185, 129, 0.4);
        }

        .recent-glow {
            box-shadow: inset 0 0 0 1px rgba(16, 185, 129, 0.3);
        }

        /* === PLATFORM ICONS === */
        .platform-icons {
            display: flex;
            gap: 4px;
        }

        .platform-icon-small {
            width: 18px;
            height: 18px;
            border-radius: 4px;
            background: rgba(255, 255, 255, 0.08);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
        }

        /* === GROUPED VIEW === */
        .group-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 0;
            margin-top: 24px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.08);
            cursor: pointer;
        }

        .group-header:first-child {
            margin-top: 0;
        }

        .group-header h3 {
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 600;
            font-size: 14px;
        }

        .group-count {
            background: rgba(255, 255, 255, 0.1);
            padding: 2px 10px;
            border-radius: 12px;
            font-size: 11px;
            color: #a1a1aa;
        }

        .group-chevron {
            transition: transform 0.2s;
        }

        .group-header.collapsed .group-chevron {
            transform: rotate(-90deg);
        }

        .group-games {
            overflow: hidden;
            transition: max-height 0.3s ease-out;
        }

        .group-games.collapsed {
            max-height: 0 !important;
        }

        /* === SORT ANIMATION === */
        .game-row,
        .game-card {
            animation: fadeSlideIn 0.3s ease-out;
        }

        @keyframes fadeSlideIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* === MICRO INTERACTIONS === */
        .game-row:hover .rating-stars {
            transform: scale(1.05);
        }

        .rating-stars {
            transition: transform 0.2s;
        }

        .game-card:hover .progress-ring .ring-fill {
            filter: drop-shadow(0 0 4px currentColor);
        }

        /* ========== RESPONSIVE DESIGN ========== */
        @media (max-width: 1200px) {
            .sidebar {
                width: 220px;
            }

            main {
                margin-left: 220px !important;
            }

            #club-grid {
                grid-template-columns: repeat(6, 1fr) !important;
            }
        }

        @media (max-width: 1024px) {
            .sidebar {
                width: 200px;
            }

            main {
                margin-left: 200px !important;
            }

            #view-library,
            #view-journal,
            #view-wishlist,
            #view-collections {
                padding-left: 1rem !important;
                padding-right: 1rem !important;
            }

            header>div {
                padding-left: 1rem !important;
                padding-right: 1rem !important;
            }

            #club-grid {
                grid-template-columns: repeat(4, 1fr) !important;
            }

            .fav-card {
                width: 110px;
                height: 65px;
            }
        }

        @media (max-width: 768px) {
            .sidebar {
                position: fixed;
                left: -260px;
                transition: left 0.3s;
                z-index: 50;
            }

            .sidebar.open {
                left: 0;
            }

            main {
                margin-left: 0 !important;
            }

            #library-controls {
                flex-wrap: wrap;
                gap: 0.5rem !important;
            }

            #library-controls>div {
                flex-wrap: wrap;
            }

            .view-toggle {
                order: -1;
            }

            #club-grid {
                grid-template-columns: repeat(3, 1fr) !important;
            }

            .fav-card {
                width: 100px;
                height: 60px;
            }

            .games-grid {
                grid-template-columns: repeat(2, 1fr) !important;
            }
        }

        @media (max-width: 480px) {
            #favorites-row {
                overflow-x: auto;
                flex-wrap: nowrap;
            }

            .fav-card {
                flex-shrink: 0;
            }

            #club-grid {
                grid-template-columns: repeat(2, 1fr) !important;
            }

            .games-grid {
                grid-template-columns: 1fr !important;
            }

            .game-row {
                flex-wrap: wrap;
                gap: 8px !important;
            }
        }
    </style>
</head>

<body class="text-white flex">
    <!-- Loading -->
    <div id="loading" class="fixed inset-0 bg-[#0c0c10] flex items-center justify-center z-50">
        <div class="w-10 h-10 border-2 border-violet-500 border-t-transparent rounded-full animate-spin"></div>
    </div>

    <!-- Sidebar -->
    <aside class="sidebar flex flex-col fixed top-0 left-0 h-screen z-40">
        <div class="p-5 border-b border-white/5">
            <a href="/game-logger/" class="flex items-center gap-2">
                <span class="text-2xl">üéÆ</span>
                <span class="text-lg font-bold gradient-text">GameLogger</span>
            </a>
        </div>

        <div class="p-5 border-b border-white/5">
            <div class="gradient-border inline-block mb-3">
                <img id="avatar" src="" class="w-14 h-14 rounded-[14px]">
            </div>
            <div id="display-name" class="font-semibold"></div>
            <div id="steam-info" class="text-xs text-zinc-500 mt-1"></div>

            <!-- Level/XP Section (under avatar) -->
            <div class="mt-3" id="level-section">
                <div class="flex items-center justify-between mb-1.5">
                    <div class="flex items-center gap-2">
                        <span class="level-badge" id="level-badge">LVL 1</span>
                        <span id="rank-title" class="text-xs text-zinc-400">Newcomer</span>
                    </div>
                </div>
                <div class="xp-bar">
                    <div class="xp-bar-fill" id="xp-bar-fill" style="width: 0%"></div>
                </div>
                <div id="xp-display" class="text-[10px] text-zinc-600 mt-1 text-right">0 / 100 XP</div>
            </div>
        </div>

        <!-- Stats (simple, no cards) -->
        <div class="px-5 py-3 grid grid-cols-4 gap-1 text-center border-b border-white/5">
            <div>
                <div id="stat-games" class="text-lg font-bold text-white">0</div>
                <div class="text-[9px] text-zinc-500 uppercase">Games</div>
            </div>
            <div>
                <div id="stat-hours" class="text-lg font-bold text-white">0</div>
                <div class="text-[9px] text-zinc-500 uppercase">Hours</div>
            </div>
            <div>
                <div id="stat-perfected" class="text-lg font-bold text-amber-400">0</div>
                <div class="text-[9px] text-zinc-500 uppercase">100%</div>
            </div>
            <div>
                <div id="stat-entries" class="text-lg font-bold text-violet-400">0</div>
                <div class="text-[9px] text-zinc-500 uppercase">Entries</div>
            </div>
        </div>



        <nav class="flex-1 p-3 space-y-1 overflow-y-auto min-h-0">
            <button onclick="switchView('library')" class="nav-link active w-full wiggle-hover" id="nav-library"><i
                    class="fa-solid fa-gamepad w-4"></i>Library</button>
            <button onclick="switchView('journal')" class="nav-link w-full wiggle-hover" id="nav-journal"><i
                    class="fa-solid fa-book w-4"></i>Journal</button>
            <button onclick="switchView('collections')" class="nav-link w-full wiggle-hover" id="nav-collections"><i
                    class="fa-solid fa-folder w-4"></i>Collections</button>
            <button onclick="switchView('wishlist')" class="nav-link w-full wiggle-hover" id="nav-wishlist"><i
                    class="fa-solid fa-heart w-4"></i>Wishlist</button>
            <button onclick="openSearchModal()" class="nav-link w-full wiggle-hover"><i
                    class="fa-solid fa-search w-4"></i>Search
                Games</button>
            <button onclick="openSettingsModal()" id="settings-btn" class="nav-link w-full wiggle-hover hidden"><i
                    class="fa-solid fa-gear w-4"></i>Settings</button>
        </nav>

        <div class="p-3 border-t border-white/5 space-y-2" id="owner-actions">
            <button onclick="syncSteam()" id="sync-btn"
                class="w-full bg-gradient-to-r from-[#1b2838] to-[#2a475e] hover:from-[#2a475e] hover:to-[#3d6b8c] py-2.5 rounded-lg text-xs font-semibold flex items-center justify-center gap-2 transition">
                <i class="fa-brands fa-steam"></i> Sync Games
            </button>
            <button onclick="syncSteamWishlist()" id="sync-wishlist-btn"
                class="w-full bg-gradient-to-r from-pink-600/20 to-violet-600/20 hover:from-pink-600/30 hover:to-violet-600/30 border border-pink-500/20 py-2.5 rounded-lg text-xs font-semibold flex items-center justify-center gap-2 transition text-pink-300">
                <i class="fa-solid fa-heart"></i> Sync Wishlist
            </button>
            <!-- Sync Indicator -->
            <div id="sync-indicator" class="text-center text-[10px] text-zinc-500 mt-2 hidden">
                <div id="last-sync">Synced: --</div>
                <div id="next-sync" class="text-violet-400/60">Next: --</div>
            </div>
        </div>

        <div class="p-3 border-t border-white/5 text-center">
            <div id="nav-auth" class="text-xs"></div>
        </div>
    </aside>

    <!-- Main -->
    <main class="flex-1 ml-[260px] min-h-screen">
        <!-- Header with Favorites -->
        <header class="sticky top-0 bg-[#0c0c10]/90 backdrop-blur-xl z-30 border-b border-white/5">
            <div class="px-8 pt-6 pb-4">
                <!-- Favorites Section -->
                <div class="mb-4">
                    <div class="flex items-center gap-3 mb-3">
                        <span class="text-lg">‚ù§Ô∏è</span>
                        <span class="text-sm font-semibold text-pink-400">Favorite Games</span>
                    </div>
                    <div id="favorites-row" class="flex gap-3"></div>
                </div>

                <!-- Quick Stats - Centered -->
                <div class="flex justify-center gap-8 mb-4">
                    <div class="text-center">
                        <div id="stat-this-year" class="text-2xl font-bold text-green-400">0</div>
                        <div class="text-[10px] text-zinc-500 uppercase tracking-wider">This Year</div>
                    </div>
                    <div class="text-center">
                        <div id="stat-backlog" class="text-2xl font-bold text-blue-400">0</div>
                        <div class="text-[10px] text-zinc-500 uppercase tracking-wider">Backlog</div>
                    </div>
                    <div class="text-center">
                        <div id="stat-wishlist" class="text-2xl font-bold text-pink-400">0</div>
                        <div class="text-[10px] text-zinc-500 uppercase tracking-wider">Wishlist</div>
                    </div>
                    <div class="text-center">
                        <div id="stat-masterpieces" class="text-2xl font-bold text-amber-400">0</div>
                        <div class="text-[10px] text-zinc-500 uppercase tracking-wider">Masterpieces</div>
                    </div>
                </div>

                <!-- Recent Activity Section -->
                <div class="mb-6" id="recent-activity-section">
                    <div class="flex items-center gap-2 mb-3">
                        <i class="fa-solid fa-clock-rotate-left text-zinc-500"></i>
                        <span class="text-xs font-semibold text-zinc-400 uppercase">Recent Activity</span>
                    </div>
                    <div class="flex gap-3 overflow-x-auto pb-2" id="recent-activity-row"></div>
                </div>


                <!-- Tabs -->
                <div class="flex items-center justify-between">
                    <div class="flex">
                        <button onclick="switchView('library')" class="tab-btn active" id="tab-library">Library</button>
                        <button onclick="switchView('journal')" class="tab-btn" id="tab-journal">Journal</button>
                        <button onclick="switchView('wishlist')" class="tab-btn" id="tab-wishlist">Wishlist</button>
                    </div>

                    <div id="library-controls" class="flex items-center gap-4">
                        <!-- View Toggle -->
                        <div class="view-toggle">
                            <button onclick="setLibraryView('list')" class="view-toggle-btn active" id="view-list"
                                title="List View">
                                <i class="fa-solid fa-list"></i>
                            </button>
                            <button onclick="setLibraryView('grid')" class="view-toggle-btn" id="view-grid"
                                title="Grid View">
                                <i class="fa-solid fa-grip"></i>
                            </button>
                            <button onclick="setLibraryView('grouped')" class="view-toggle-btn" id="view-grouped"
                                title="Grouped View">
                                <i class="fa-solid fa-layer-group"></i>
                            </button>
                        </div>
                        <div class="flex gap-1">
                            <button onclick="filterGames('all')" class="filter-pill active" id="f-all">All</button>
                            <button onclick="filterGames('played')" class="filter-pill" id="f-played">Played</button>
                            <button onclick="filterGames('finished')" class="filter-pill"
                                id="f-finished">Finished</button>
                            <button onclick="filterGames('perfected')" class="filter-pill"
                                id="f-perfected">100%</button>
                            <button onclick="filterGames('backlog')" class="filter-pill" id="f-backlog">Backlog</button>
                        </div>
                        <input type="text" id="search-input" placeholder="Search..." oninput="renderGames()"
                            class="w-36 py-2 px-3 text-sm">
                        <select id="sort-select" onchange="renderGames()" class="py-2 text-sm">
                            <option value="playtime">Playtime</option>
                            <option value="name">Name</option>
                            <option value="recent">Recent</option>
                            <option value="rating">Rating</option>
                        </select>
                        <select id="platform-filter" onchange="renderGames()" class="py-2 text-sm">
                            <option value="all">All Platforms</option>
                            <option value="steam">Steam</option>
                            <option value="playstation">PlayStation</option>
                            <option value="xbox">Xbox</option>
                            <option value="nintendo">Nintendo</option>
                            <option value="pc">PC</option>
                            <option value="mobile">Mobile</option>
                        </select>
                        <button onclick="toggleMultiSelect()" id="multiselect-toggle"
                            class="px-3 py-2 text-sm rounded-lg bg-white/5 hover:bg-white/10 text-zinc-400 hover:text-white transition"
                            title="Multi-select mode">
                            <i class="fa-solid fa-check-double"></i>
                        </button>
                    </div>

                    <div id="journal-controls" class="hidden">
                        <button onclick="openEntryModal()" class="btn-glow px-5 py-2 rounded-lg text-sm font-medium">
                            <i class="fa-solid fa-plus mr-2"></i>New Entry
                        </button>
                    </div>
                </div>
            </div>
        </header>

        <!-- Library View -->
        <section id="view-library" class="px-8 py-6">
            <!-- 100% Club (Collapsible) -->
            <div id="club-section" class="mb-8 hidden">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="flex items-center gap-2 font-semibold"><span class="text-xl">üèÜ</span><span
                            class="text-amber-400">100% Club</span></h2>
                    <div class="flex items-center gap-2">
                        <button onclick="toggleClub()" id="club-toggle"
                            class="text-xs text-violet-400 hover:text-violet-300">Show All</button>
                        <button onclick="toggleClubVisibility()" id="club-hide-btn"
                            class="text-xs text-zinc-500 hover:text-zinc-300"><i
                                class="fa-solid fa-eye-slash"></i></button>
                    </div>
                </div>
                <div id="club-grid" class="grid grid-cols-8 gap-3"></div>
            </div>

            <!-- Games Container (List/Grid/Grouped) -->
            <div id="games-list" class="space-y-1"></div>
            <div id="games-grid" class="games-grid hidden"></div>
            <div id="games-grouped" class="hidden"></div>
            <div id="no-games" class="hidden text-center py-20 text-zinc-500">
                <div class="text-5xl mb-4 opacity-30">üéÆ</div>
                <p>No games found</p>
            </div>

            <!-- Multi-select Floating Action Bar -->
            <div id="multiselect-bar"
                class="hidden fixed bottom-6 left-1/2 transform -translate-x-1/2 ml-[130px] bg-zinc-900/95 backdrop-blur-xl px-6 py-3 rounded-2xl border border-white/10 shadow-2xl flex items-center gap-4 z-40">
                <div class="flex items-center gap-2 text-sm">
                    <span id="selected-count" class="font-bold text-violet-400">0</span>
                    <span class="text-zinc-400">selected</span>
                </div>
                <div class="h-6 w-px bg-white/10"></div>
                <button onclick="bulkSetStatus('backlog')"
                    class="px-3 py-1.5 bg-white/5 hover:bg-white/10 rounded-lg text-xs transition">üìã Backlog</button>
                <button onclick="bulkSetStatus('played')"
                    class="px-3 py-1.5 bg-white/5 hover:bg-white/10 rounded-lg text-xs transition">üéÆ Playing</button>
                <button onclick="bulkSetStatus('finished')"
                    class="px-3 py-1.5 bg-white/5 hover:bg-white/10 rounded-lg text-xs transition">‚úÖ Finished</button>
                <button onclick="bulkHideGames()"
                    class="px-3 py-1.5 bg-red-500/10 hover:bg-red-500/20 text-red-400 rounded-lg text-xs transition">
                    <i class="fa-solid fa-eye-slash mr-1"></i> Hide
                </button>
                <div class="h-6 w-px bg-white/10"></div>
                <button onclick="selectAllGames()" class="text-xs text-zinc-400 hover:text-white transition">Select
                    All</button>
                <button onclick="clearSelection()"
                    class="text-xs text-zinc-400 hover:text-white transition">Clear</button>
            </div>
        </section>

        <!-- Journal View -->
        <section id="view-journal" class="hidden px-8 py-6">
            <div id="journal-list"></div>
            <div id="no-entries" class="hidden text-center py-20 text-zinc-500">
                <div class="text-5xl mb-4 opacity-30">üìì</div>
                <p class="mb-4">No journal entries yet</p>
                <button onclick="openEntryModal()" class="btn-glow px-6 py-2.5 rounded-xl text-sm font-medium">Add First
                    Entry</button>
            </div>
        </section>

        <!-- Wishlist View -->
        <section id="view-wishlist" class="hidden px-8 py-6">
            <div id="wishlist-grid" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4"></div>
            <div id="no-wishlist" class="hidden text-center py-20 text-zinc-500">
                <div class="text-5xl mb-4 opacity-30">üíñ</div>
                <p class="mb-4">Your wishlist is empty</p>
                <p class="text-sm mb-4">Search for games and add them to your wishlist!</p>
                <button onclick="openSearchModal()" class="btn-glow px-6 py-2.5 rounded-xl text-sm font-medium">
                    <i class="fa-solid fa-search mr-2"></i>Search Games
                </button>
            </div>
        </section>

        <!-- Collections View -->
        <section id="view-collections" class="hidden px-8 py-6">
            <div class="flex items-center justify-between mb-6">
                <h2 class="text-xl font-bold">Your Collections</h2>
                <button onclick="openCollectionModal()" class="btn-glow px-4 py-2 rounded-lg text-sm font-medium">
                    <i class="fa-solid fa-plus mr-2"></i>New Collection
                </button>
            </div>
            <div id="collections-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"></div>
            <div id="no-collections" class="hidden text-center py-20 text-zinc-500">
                <div class="text-5xl mb-4 opacity-30">üìÅ</div>
                <p class="mb-4">No collections yet</p>
                <p class="text-sm mb-4">Create collections to organize your games!</p>
                <button onclick="openCollectionModal()" class="btn-glow px-6 py-2.5 rounded-xl text-sm font-medium">
                    <i class="fa-solid fa-plus mr-2"></i>Create First Collection
                </button>
            </div>
        </section>
    </main>

    <!-- Game Modal -->
    <div id="game-modal" class="fixed inset-0 z-50 hidden flex items-center justify-center p-4"
        onclick="if(event.target===this)closeGameModal()">
        <div class="modal-overlay absolute inset-0"></div>
        <div class="modal-card relative w-full max-w-lg max-h-[90vh] overflow-y-auto">
            <div class="relative h-32">
                <img id="gm-header" src="" class="w-full h-full object-cover">
                <div class="absolute inset-0 bg-gradient-to-t from-[#1a1a24] to-transparent"></div>
                <button onclick="closeGameModal()"
                    class="absolute top-3 right-3 w-8 h-8 bg-black/50 rounded-full flex items-center justify-center hover:bg-black/70"><i
                        class="fa-solid fa-xmark"></i></button>
            </div>
            <div class="p-6 -mt-8 relative">
                <div class="flex gap-4 mb-5">
                    <div class="gradient-border shrink-0"><img id="gm-icon" src="" class="w-14 h-14 rounded-xl"></div>
                    <div>
                        <h2 id="gm-title" class="text-lg font-bold"></h2>
                        <div id="gm-meta" class="text-sm text-zinc-400"></div>
                    </div>
                </div>
                <div id="gm-controls" class="space-y-5">
                    <div><label class="block text-xs text-zinc-500 uppercase mb-2">Status</label>
                        <div id="gm-status" class="flex flex-wrap gap-2"></div>
                    </div>
                    <!-- Backlog Priority (shown when status is backlog) -->
                    <div id="gm-priority-section" class="hidden">
                        <label class="block text-xs text-zinc-500 uppercase mb-2">Backlog Priority</label>
                        <div id="gm-priority" class="flex gap-2">
                            <button onclick="setGamePriority(3)"
                                class="priority-btn px-3 py-1.5 rounded-lg text-xs transition bg-red-500/10 text-red-400 border border-transparent hover:border-red-500/50"
                                data-priority="3">üî• High</button>
                            <button onclick="setGamePriority(2)"
                                class="priority-btn px-3 py-1.5 rounded-lg text-xs transition bg-amber-500/10 text-amber-400 border border-transparent hover:border-amber-500/50"
                                data-priority="2">‚ö° Medium</button>
                            <button onclick="setGamePriority(1)"
                                class="priority-btn px-3 py-1.5 rounded-lg text-xs transition bg-blue-500/10 text-blue-400 border border-transparent hover:border-blue-500/50"
                                data-priority="1">üí§ Low</button>
                            <button onclick="setGamePriority(0)"
                                class="priority-btn px-3 py-1.5 rounded-lg text-xs transition bg-white/5 text-zinc-400 border border-transparent hover:border-white/20"
                                data-priority="0">None</button>
                        </div>
                    </div>
                    <!-- Category Ratings -->
                    <div class="border-t border-white/5 pt-4">
                        <div class="flex items-center justify-between mb-3">
                            <label class="text-xs text-zinc-500 uppercase">Rating</label>
                            <div id="gm-overall-rating" class="flex items-center gap-2">
                                <span class="text-zinc-500 text-xs">Overall:</span>
                                <span id="gm-overall-stars" class="text-amber-400"></span>
                                <span id="gm-overall-value" class="text-amber-400 font-medium text-sm"></span>
                            </div>
                        </div>
                        <div class="space-y-2">
                            <div class="flex items-center justify-between">
                                <label class="flex items-center gap-2">
                                    <input type="checkbox" id="gm-cat-story-toggle" checked
                                        class="accent-violet-500 w-3 h-3" onchange="toggleGameCategory('story')">
                                    <span class="text-xs text-zinc-400 w-16">Story</span>
                                </label>
                                <div id="gm-cat-story" class="game-cat-rating flex gap-0.5" data-cat="story"></div>
                            </div>
                            <div class="flex items-center justify-between">
                                <label class="flex items-center gap-2">
                                    <input type="checkbox" id="gm-cat-gameplay-toggle" checked
                                        class="accent-violet-500 w-3 h-3" onchange="toggleGameCategory('gameplay')">
                                    <span class="text-xs text-zinc-400 w-16">Gameplay</span>
                                </label>
                                <div id="gm-cat-gameplay" class="game-cat-rating flex gap-0.5" data-cat="gameplay">
                                </div>
                            </div>
                            <div class="flex items-center justify-between">
                                <label class="flex items-center gap-2">
                                    <input type="checkbox" id="gm-cat-graphics-toggle" checked
                                        class="accent-violet-500 w-3 h-3" onchange="toggleGameCategory('graphics')">
                                    <span class="text-xs text-zinc-400 w-16">Graphics</span>
                                </label>
                                <div id="gm-cat-graphics" class="game-cat-rating flex gap-0.5" data-cat="graphics">
                                </div>
                            </div>
                            <div class="flex items-center justify-between">
                                <label class="flex items-center gap-2">
                                    <input type="checkbox" id="gm-cat-audio-toggle" checked
                                        class="accent-violet-500 w-3 h-3" onchange="toggleGameCategory('audio')">
                                    <span class="text-xs text-zinc-400 w-16">Audio</span>
                                </label>
                                <div id="gm-cat-audio" class="game-cat-rating flex gap-0.5" data-cat="audio"></div>
                            </div>
                        </div>
                        <button onclick="clearGameRatings()"
                            class="text-xs text-zinc-500 hover:text-zinc-300 mt-2">Clear ratings</button>
                    </div>
                    <div class="flex gap-6 pt-2">
                        <label class="flex items-center gap-2 text-sm cursor-pointer"><input type="checkbox"
                                id="gm-favorite" onchange="saveGameProp('favorite',this.checked)"
                                class="accent-pink-500"><span>‚ù§Ô∏è Favorite</span></label>
                        <label class="flex items-center gap-2 text-sm cursor-pointer"><input type="checkbox"
                                id="gm-hidden" onchange="saveGameProp('hidden',this.checked);closeGameModal();render()"
                                class="accent-zinc-500"><span>üëÅÔ∏è Hidden</span></label>
                    </div>
                    <!-- Platform Picker -->
                    <div class="pt-4 border-t border-white/5">
                        <label class="block text-xs text-zinc-500 uppercase mb-2">Platforms</label>
                        <div id="gm-platforms" class="flex flex-wrap gap-2"></div>
                        <div class="flex gap-2 mt-3">
                            <input type="text" id="custom-platform-name" placeholder="New platform name..."
                                class="flex-1 py-1.5 px-3 text-sm">
                            <button onclick="addCustomPlatform()"
                                class="px-3 py-1.5 bg-violet-500/20 hover:bg-violet-500/30 text-violet-400 rounded-lg text-sm font-medium transition">+
                                Add</button>
                        </div>
                    </div>
                    <!-- Completion Date -->
                    <div class="pt-4 border-t border-white/5">
                        <label class="block text-xs text-zinc-500 uppercase mb-2">Completed On</label>
                        <input type="date" id="gm-completed" onchange="saveGameProp('completedAt',this.value)"
                            class="py-2 px-3 text-sm w-auto">
                        <button onclick="clearCompletedDate()"
                            class="text-xs text-zinc-500 hover:text-zinc-300 ml-2">Clear</button>
                    </div>
                    <!-- Notes -->
                    <div class="pt-4 border-t border-white/5">
                        <label class="block text-xs text-zinc-500 uppercase mb-2">Personal Notes</label>
                        <textarea id="gm-notes" placeholder="Add your thoughts, tips, or memories about this game..."
                            class="w-full py-2 px-3 text-sm h-20 resize-none"
                            onblur="saveGameProp('notes',this.value)"></textarea>
                    </div>
                    <!-- View Details Button -->
                    <div class="pt-4 border-t border-white/5">
                        <button onclick="openGamePage()"
                            class="w-full text-center py-2.5 rounded-lg bg-gradient-to-r from-violet-500/20 to-pink-500/20 hover:from-violet-500/30 hover:to-pink-500/30 text-violet-400 font-medium transition">
                            <i class="fa-solid fa-arrow-up-right-from-square mr-2"></i>View Full Details
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Journal Entry Modal -->
    <div id="entry-modal" class="fixed inset-0 z-50 hidden overflow-y-auto"
        onclick="if(event.target===this)closeEntryModal()">
        <div class="modal-overlay absolute inset-0"></div>
        <div class="relative z-10 max-w-lg mx-auto mt-12 mb-12">
            <div class="modal-card overflow-hidden">
                <!-- Header -->
                <div class="bg-gradient-to-r from-violet-600/20 to-pink-600/20 px-6 py-5 border-b border-white/5">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 rounded-xl bg-violet-500/20 flex items-center justify-center">
                                <i class="fa-solid fa-book text-violet-400"></i>
                            </div>
                            <div>
                                <h3 class="font-bold">New Journal Entry</h3>
                                <p class="text-xs text-zinc-400">Log your gaming session</p>
                            </div>
                        </div>
                        <button onclick="closeEntryModal()"
                            class="w-8 h-8 rounded-full bg-white/5 flex items-center justify-center hover:bg-white/10">
                            <i class="fa-solid fa-xmark text-zinc-400"></i>
                        </button>
                    </div>
                </div>

                <div class="p-6 space-y-5">
                    <!-- Game Search -->
                    <div class="bg-white/5 rounded-xl p-4">
                        <label class="block text-xs text-zinc-500 uppercase mb-2">
                            <i class="fa-solid fa-gamepad mr-1"></i> Game
                        </label>
                        <div class="relative">
                            <input type="text" id="entry-game-search" placeholder="Search your library..."
                                class="w-full" oninput="filterEntryGames()" onfocus="showEntryGameList()">
                            <input type="hidden" id="entry-game">
                            <div id="entry-game-list"
                                class="hidden absolute z-10 left-0 right-0 top-full mt-1 bg-[#1a1a24] border border-white/10 rounded-lg max-h-48 overflow-y-auto shadow-xl">
                            </div>
                        </div>
                        <div id="entry-game-selected"
                            class="hidden mt-2 flex items-center gap-2 bg-violet-500/10 rounded-lg p-2">
                            <img id="entry-game-icon" class="w-8 h-8 rounded object-cover">
                            <span id="entry-game-name" class="text-sm font-medium"></span>
                            <button onclick="clearEntryGame()" class="ml-auto text-zinc-500 hover:text-white">
                                <i class="fa-solid fa-xmark"></i>
                            </button>
                        </div>
                    </div>

                    <!-- Session Time -->
                    <div class="grid grid-cols-3 gap-2">
                        <div class="bg-white/5 rounded-lg p-3">
                            <label class="block text-xs text-zinc-500 uppercase mb-2">
                                <i class="fa-solid fa-calendar mr-1"></i> Date
                            </label>
                            <input type="date" id="entry-date" class="w-full text-sm">
                        </div>
                        <div class="bg-white/5 rounded-lg p-3">
                            <label class="block text-xs text-zinc-500 uppercase mb-2">
                                <i class="fa-solid fa-clock mr-1"></i> Duration
                            </label>
                            <div class="flex gap-1">
                                <input type="number" id="entry-hours" placeholder="0" min="0"
                                    class="w-full text-sm text-center" style="padding: 6px 4px;">
                                <span class="text-zinc-500 text-xs self-center">h</span>
                                <input type="number" id="entry-mins" placeholder="0" min="0" max="59"
                                    class="w-full text-sm text-center" style="padding: 6px 4px;">
                                <span class="text-zinc-500 text-xs self-center">m</span>
                            </div>
                        </div>
                        <div class="bg-white/5 rounded-lg p-3">
                            <label class="block text-xs text-zinc-500 uppercase mb-2">
                                <i class="fa-solid fa-flag mr-1"></i> Status
                            </label>
                            <select id="entry-status" class="w-full text-sm py-1.5">
                                <option value="playing">Playing</option>
                                <option value="finished">Finished</option>
                                <option value="perfected">100%</option>
                                <option value="dropped">Dropped</option>
                                <option value="on_hold">On Hold</option>
                            </select>
                        </div>
                    </div>

                    <!-- Ratings (with half-star support) -->
                    <div class="bg-white/5 rounded-lg p-3">
                        <div class="flex items-center justify-between mb-2">
                            <label class="text-xs text-zinc-500 uppercase">
                                <i class="fa-solid fa-star mr-1"></i> Session Ratings
                            </label>
                            <div id="calculated-rating" class="flex items-center gap-1">
                                <span class="text-xs text-zinc-500">‚Äî</span>
                            </div>
                        </div>
                        <div class="grid grid-cols-2 gap-2">
                            <div class="flex items-center justify-between">
                                <label class="text-xs text-zinc-400 w-14">Story</label>
                                <div class="entry-rating-stars flex gap-0.5" data-r="story"></div>
                            </div>
                            <div class="flex items-center justify-between">
                                <label class="text-xs text-zinc-400 w-14">Gameplay</label>
                                <div class="entry-rating-stars flex gap-0.5" data-r="gameplay"></div>
                            </div>
                            <div class="flex items-center justify-between">
                                <label class="text-xs text-zinc-400 w-14">Graphics</label>
                                <div class="entry-rating-stars flex gap-0.5" data-r="graphics"></div>
                            </div>
                            <div class="flex items-center justify-between">
                                <label class="text-xs text-zinc-400 w-14">Audio</label>
                                <div class="entry-rating-stars flex gap-0.5" data-r="audio"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Thoughts & Discoveries -->
                    <div class="grid grid-cols-1 gap-4">
                        <div class="bg-white/5 rounded-xl p-4">
                            <label class="block text-xs text-zinc-500 uppercase mb-2">
                                <i class="fa-solid fa-comment mr-1"></i> Thoughts
                            </label>
                            <textarea id="entry-thoughts" rows="2" class="w-full text-sm"
                                placeholder="How was the session?"></textarea>
                        </div>
                        <div class="bg-white/5 rounded-xl p-4">
                            <label class="block text-xs text-zinc-500 uppercase mb-2">
                                <i class="fa-solid fa-lightbulb mr-1"></i> Discoveries
                            </label>
                            <textarea id="entry-discoveries" rows="2" class="w-full text-sm"
                                placeholder="New areas, achievements, content?"></textarea>
                        </div>
                    </div>

                    <!-- Actions -->
                    <div class="flex gap-3 pt-2">
                        <button onclick="closeEntryModal()"
                            class="flex-1 py-3 rounded-lg bg-white/5 hover:bg-white/10 text-sm font-medium transition">
                            Cancel
                        </button>
                        <button id="entry-submit-btn" onclick="saveOrUpdateEntry()"
                            class="flex-1 py-3 rounded-lg btn-glow text-sm font-bold transition flex items-center justify-center gap-2">
                            <i class="fa-solid fa-save"></i> <span id="entry-submit-text">Save Entry</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Search Modal -->
    <div id="search-modal" class="fixed inset-0 z-50 hidden overflow-y-auto"
        onclick="if(event.target===this)closeSearchModal()">
        <div class="modal-overlay absolute inset-0"></div>
        <div class="relative z-10 max-w-2xl mx-auto mt-16 mb-16">
            <div class="modal-card p-6">
                <div class="flex items-center justify-between mb-5">
                    <h3 class="text-lg font-bold gradient-text">Search Games</h3>
                    <button onclick="closeSearchModal()" class="text-zinc-400 hover:text-white"><i
                            class="fa-solid fa-xmark"></i></button>
                </div>
                <div class="relative mb-4">
                    <i class="fa-solid fa-search absolute left-4 top-1/2 -translate-y-1/2 text-zinc-500"></i>
                    <input type="text" id="search-query" placeholder="Search 500,000+ games..."
                        class="w-full pl-11 py-3" oninput="debounceSearch()">
                </div>
                <div class="flex gap-2 mb-4">
                    <button onclick="setPlatform('all')" class="filter-pill active" id="sp-all">All</button>
                    <button onclick="setPlatform('pc')" class="filter-pill" id="sp-pc">PC</button>
                    <button onclick="setPlatform('playstation')" class="filter-pill"
                        id="sp-playstation">PlayStation</button>
                    <button onclick="setPlatform('xbox')" class="filter-pill" id="sp-xbox">Xbox</button>
                    <button onclick="setPlatform('nintendo')" class="filter-pill" id="sp-nintendo">Nintendo</button>
                </div>
                <div id="search-results" class="max-h-96 overflow-y-auto space-y-2"></div>
                <div id="search-loading" class="hidden text-center py-8">
                    <div
                        class="w-6 h-6 border-2 border-violet-500 border-t-transparent rounded-full animate-spin mx-auto">
                    </div>
                </div>
                <div id="search-empty" class="hidden text-center py-8 text-zinc-500">Start typing to search...</div>
                <p class="text-xs text-zinc-600 mt-4 text-center">Powered by RAWG</p>
            </div>
        </div>
    </div>

    <!-- Collection Modal -->
    <div id="collection-modal" class="fixed inset-0 z-50 hidden overflow-y-auto"
        onclick="if(event.target===this)closeCollectionModal()">
        <div class="modal-overlay absolute inset-0"></div>
        <div class="relative z-10 max-w-lg mx-auto mt-12 mb-12">
            <div class="modal-card p-6">
                <div class="flex items-center justify-between mb-5">
                    <h3 id="collection-modal-title" class="text-lg font-bold gradient-text">New Collection</h3>
                    <button onclick="closeCollectionModal()" class="text-zinc-400 hover:text-white"><i
                            class="fa-solid fa-xmark"></i></button>
                </div>

                <div class="space-y-4">
                    <div>
                        <label class="text-xs text-zinc-500 uppercase mb-1 block">Name</label>
                        <input type="text" id="collection-name" placeholder="My Collection" class="w-full py-2 px-3">
                    </div>

                    <div>
                        <label class="text-xs text-zinc-500 uppercase mb-1 block">Description (optional)</label>
                        <textarea id="collection-desc" placeholder="What's this collection about?"
                            class="w-full py-2 px-3 h-20 resize-none"></textarea>
                    </div>

                    <div>
                        <label class="text-xs text-zinc-500 uppercase mb-2 block">Color</label>
                        <div id="collection-colors" class="flex gap-2 flex-wrap">
                            <button onclick="setCollectionColor('violet')"
                                class="w-8 h-8 rounded-full bg-violet-500 ring-2 ring-violet-500 ring-offset-2 ring-offset-zinc-900"></button>
                            <button onclick="setCollectionColor('pink')"
                                class="w-8 h-8 rounded-full bg-pink-500"></button>
                            <button onclick="setCollectionColor('blue')"
                                class="w-8 h-8 rounded-full bg-blue-500"></button>
                            <button onclick="setCollectionColor('green')"
                                class="w-8 h-8 rounded-full bg-green-500"></button>
                            <button onclick="setCollectionColor('amber')"
                                class="w-8 h-8 rounded-full bg-amber-500"></button>
                            <button onclick="setCollectionColor('red')"
                                class="w-8 h-8 rounded-full bg-red-500"></button>
                            <button onclick="setCollectionColor('cyan')"
                                class="w-8 h-8 rounded-full bg-cyan-500"></button>
                        </div>
                    </div>

                    <div>
                        <label class="text-xs text-zinc-500 uppercase mb-2 block">Add Games</label>
                        <input type="text" id="collection-game-search" placeholder="Search your library..."
                            class="w-full py-2 px-3 mb-2" oninput="filterCollectionGames()">
                        <div id="collection-games-list" class="max-h-48 overflow-y-auto space-y-1"></div>
                    </div>

                    <div>
                        <label class="text-xs text-zinc-500 uppercase mb-2 block">Selected Games (<span
                                id="collection-count">0</span>)</label>
                        <div id="collection-selected"
                            class="flex flex-wrap gap-2 min-h-[40px] p-2 bg-white/5 rounded-lg"></div>
                    </div>
                </div>

                <div class="flex gap-3 mt-6">
                    <button onclick="closeCollectionModal()"
                        class="flex-1 py-2.5 rounded-lg bg-white/5 hover:bg-white/10 transition">Cancel</button>
                    <button onclick="saveCollection()" class="flex-1 py-2.5 rounded-lg btn-glow font-medium">
                        <i class="fa-solid fa-check mr-2"></i>Save Collection
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settings-modal" class="fixed inset-0 z-50 hidden overflow-y-auto"
        onclick="if(event.target===this)closeSettingsModal()">
        <div class="modal-overlay absolute inset-0"></div>
        <div class="relative z-10 max-w-lg mx-auto mt-12 mb-12">
            <div class="modal-card overflow-hidden">
                <div class="bg-gradient-to-r from-violet-600/20 to-pink-600/20 px-6 py-5 border-b border-white/5">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 rounded-xl bg-violet-500/20 flex items-center justify-center">
                                <i class="fa-solid fa-gear text-violet-400"></i>
                            </div>
                            <div>
                                <h3 class="font-bold">Settings</h3>
                                <p class="text-xs text-zinc-400">Customize your profile</p>
                            </div>
                        </div>
                        <button onclick="closeSettingsModal()"
                            class="w-8 h-8 rounded-full bg-white/5 flex items-center justify-center hover:bg-white/10">
                            <i class="fa-solid fa-xmark text-zinc-400"></i>
                        </button>
                    </div>
                </div>
                <div class="p-6 space-y-6">
                    <!-- Profile URL -->
                    <div class="bg-white/5 rounded-xl p-4">
                        <div class="flex items-center gap-3 mb-3">
                            <i class="fa-solid fa-link text-violet-400"></i>
                            <h4 class="font-medium text-sm">Profile URL</h4>
                        </div>
                        <div class="flex gap-2 mb-2">
                            <div class="flex-1 flex items-center bg-black/30 rounded-lg overflow-hidden">
                                <span class="px-3 text-xs text-zinc-500">kierxn.netlify.app/game-logger/</span>
                                <input type="text" id="set-username" placeholder="username"
                                    class="flex-1 bg-transparent border-none text-sm">
                            </div>
                            <button onclick="saveUsername()" class="px-4 btn-glow rounded-lg text-sm">Save</button>
                        </div>
                        <p class="text-xs text-zinc-500">Your public profile: <span id="current-username"
                                class="text-violet-400 font-medium"></span></p>
                    </div>

                    <!-- Steam Connection -->
                    <div class="bg-white/5 rounded-xl p-4">
                        <div class="flex items-center gap-3 mb-3">
                            <i class="fa-brands fa-steam text-[#66c0f4]"></i>
                            <h4 class="font-medium text-sm">Steam Connection</h4>
                        </div>
                        <div id="steam-status" class="space-y-3">
                            <span class="text-sm text-zinc-400">Loading...</span>
                        </div>
                        <div id="steam-unlink" class="hidden mt-3 pt-3 border-t border-white/5">
                            <p class="text-xs text-zinc-500 mb-2">Unlinking Steam will remove all your library data.
                                This cannot be undone.</p>
                            <button onclick="unlinkSteam()"
                                class="w-full py-2 rounded-lg bg-red-500/10 text-red-400 hover:bg-red-500/20 text-xs flex items-center justify-center gap-2">
                                <i class="fa-solid fa-unlink"></i> Unlink Steam Account
                            </button>
                        </div>
                    </div>

                    <!-- Hidden Games -->
                    <div class="bg-white/5 rounded-xl p-4">
                        <div class="flex items-center gap-3 mb-3">
                            <i class="fa-solid fa-eye-slash text-zinc-400"></i>
                            <h4 class="font-medium text-sm">Hidden Games</h4>
                        </div>
                        <div id="hidden-games-list" class="max-h-32 overflow-y-auto space-y-2"></div>
                    </div>

                    <!-- Export -->
                    <div class="bg-white/5 rounded-xl p-4">
                        <div class="flex items-center gap-3 mb-3">
                            <i class="fa-solid fa-download text-green-400"></i>
                            <h4 class="font-medium text-sm">Export Library</h4>
                        </div>
                        <p class="text-xs text-zinc-500 mb-3">Download your complete library data as JSON including
                            games, stats, journal entries, and notes.</p>
                        <button onclick="exportLibrary()"
                            class="w-full py-2.5 rounded-lg bg-green-500/10 text-green-400 hover:bg-green-500/20 text-sm flex items-center justify-center gap-2">
                            <i class="fa-solid fa-file-export"></i> Export to JSON
                        </button>
                    </div>

                    <!-- Danger Zone -->
                    <div class="bg-red-500/5 border border-red-500/20 rounded-xl p-4">
                        <div class="flex items-center gap-3 mb-3">
                            <i class="fa-solid fa-triangle-exclamation text-red-400"></i>
                            <h4 class="font-medium text-sm text-red-400">Danger Zone</h4>
                        </div>
                        <div class="space-y-2">
                            <button onclick="clearJournal()"
                                class="w-full py-2.5 rounded-lg bg-red-500/10 text-red-400 hover:bg-red-500/20 text-sm flex items-center justify-center gap-2">
                                <i class="fa-solid fa-trash-can"></i> Clear All Journal Entries
                            </button>
                            <button onclick="clearWishlist()"
                                class="w-full py-2.5 rounded-lg bg-red-500/10 text-red-400 hover:bg-red-500/20 text-sm flex items-center justify-center gap-2">
                                <i class="fa-solid fa-heart-crack"></i> Clear Wishlist
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Favorite Picker -->
    <div id="fav-modal" class="fixed inset-0 z-50 hidden flex items-center justify-center p-4"
        onclick="if(event.target===this)closeFavModal()">
        <div class="modal-overlay absolute inset-0"></div>
        <div class="modal-card relative w-full max-w-sm p-5">
            <h3 class="font-bold mb-4">Select Favorite</h3>
            <input type="text" id="fav-search" placeholder="Search..." class="w-full mb-3" oninput="renderFavList()">
            <div id="fav-list" class="max-h-60 overflow-y-auto space-y-1"></div>
            <button onclick="clearFavSlot()" class="text-xs text-red-400 mt-3">Remove</button>
        </div>
    </div>

    <!-- Add Game Modal -->
    <div id="add-game-modal" class="fixed inset-0 z-50 hidden flex items-center justify-center p-4"
        onclick="if(event.target===this)closeAddGame()">
        <div class="modal-overlay absolute inset-0"></div>
        <div class="modal-card relative w-full max-w-md overflow-hidden">
            <div class="bg-gradient-to-r from-green-600/20 to-emerald-600/20 px-6 py-4 border-b border-white/5">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 rounded-xl bg-green-500/20 flex items-center justify-center">
                        <i class="fa-solid fa-plus text-green-400"></i>
                    </div>
                    <div>
                        <h3 class="font-bold">Add Game Manually</h3>
                        <p class="text-xs text-zinc-400">For non-Steam games</p>
                    </div>
                </div>
            </div>
            <div class="p-6 space-y-4">
                <div>
                    <label class="block text-xs text-zinc-500 uppercase mb-2">Game Name</label>
                    <input type="text" id="ag-name" placeholder="e.g. The Legend of Zelda: TOTK" class="w-full">
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-xs text-zinc-500 uppercase mb-2">Platform</label>
                        <select id="ag-platform" class="w-full">
                            <option value="playstation">üéÆ PlayStation</option>
                            <option value="xbox">üéÆ Xbox</option>
                            <option value="nintendo">üéÆ Nintendo</option>
                            <option value="pc">üíª PC (Other)</option>
                            <option value="mobile">üì± Mobile</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-xs text-zinc-500 uppercase mb-2">Hours Played</label>
                        <input type="number" id="ag-hours" placeholder="0" class="w-full">
                    </div>
                </div>
                <div>
                    <label class="block text-xs text-zinc-500 uppercase mb-2">Status</label>
                    <div class="grid grid-cols-4 gap-2">
                        <button type="button" onclick="setAddGameStatus('backlog')"
                            class="ag-status-btn py-2 rounded-lg bg-white/5 text-xs text-zinc-400 hover:bg-white/10"
                            data-status="backlog">Backlog</button>
                        <button type="button" onclick="setAddGameStatus('played')"
                            class="ag-status-btn py-2 rounded-lg bg-white/5 text-xs text-zinc-400 hover:bg-white/10"
                            data-status="played">Played</button>
                        <button type="button" onclick="setAddGameStatus('finished')"
                            class="ag-status-btn py-2 rounded-lg bg-white/5 text-xs text-zinc-400 hover:bg-white/10"
                            data-status="finished">Finished</button>
                        <button type="button" onclick="setAddGameStatus('perfected')"
                            class="ag-status-btn py-2 rounded-lg bg-white/5 text-xs text-zinc-400 hover:bg-white/10"
                            data-status="perfected">100%</button>
                    </div>
                </div>
                <div>
                    <label class="block text-xs text-zinc-500 uppercase mb-2">Rating (Optional)</label>
                    <div id="ag-rating" class="flex gap-1"></div>
                </div>
                <div class="flex gap-3 pt-2">
                    <button onclick="closeAddGame()"
                        class="flex-1 py-3 rounded-xl bg-white/5 hover:bg-white/10 text-sm font-medium">Cancel</button>
                    <button onclick="submitAddGame()" class="flex-1 py-3 rounded-xl btn-glow text-sm font-medium">
                        <i class="fa-solid fa-plus mr-2"></i>Add Game
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Game Preview Modal (Search Results) -->
    <div id="game-preview-modal" class="fixed inset-0 z-50 hidden flex items-center justify-center p-4"
        onclick="if(event.target===this)closeGamePreview()">
        <div class="modal-overlay absolute inset-0"></div>
        <div class="modal-card relative w-full max-w-lg overflow-hidden">
            <div class="relative h-48">
                <img id="gp-bg" src="" class="w-full h-full object-cover">
                <div class="absolute inset-0 bg-gradient-to-t from-[#1a1a24] via-[#1a1a24]/50 to-transparent"></div>
                <button onclick="closeGamePreview()"
                    class="absolute top-3 right-3 w-8 h-8 bg-black/50 rounded-full flex items-center justify-center hover:bg-black/70"><i
                        class="fa-solid fa-xmark"></i></button>
            </div>
            <div class="p-6 -mt-16 relative">
                <h2 id="gp-title" class="text-xl font-bold mb-2"></h2>
                <p id="gp-meta" class="text-sm text-zinc-400 mb-3"></p>
                <div id="gp-platforms" class="flex flex-wrap gap-2 mb-5"></div>

                <!-- Status Messages -->
                <div id="gp-owned" class="hidden mb-4 p-3 bg-green-500/10 border border-green-500/20 rounded-xl">
                    <div class="flex items-center gap-2 text-green-400 text-sm"><i
                            class="fa-solid fa-check-circle"></i>Already in your library</div>
                </div>
                <div id="gp-wishlisted" class="hidden mb-4 p-3 bg-pink-500/10 border border-pink-500/20 rounded-xl">
                    <div class="flex items-center gap-2 text-pink-400 text-sm"><i class="fa-solid fa-heart"></i>On your
                        wishlist</div>
                </div>

                <!-- Actions for non-owned games -->
                <div id="gp-add-actions" class="space-y-2 hidden">
                    <button onclick="addFromPreview()" class="w-full py-3 rounded-xl btn-glow text-sm font-medium">
                        <i class="fa-solid fa-plus mr-2"></i>Add to Library
                    </button>
                    <button id="gp-wishlist-btn" onclick="addToWishlist(previewGame)"
                        class="w-full py-3 rounded-xl bg-pink-500/10 text-pink-400 hover:bg-pink-500/20 text-sm font-medium">
                        <i class="fa-solid fa-heart mr-2"></i>Add to Wishlist
                    </button>
                </div>

                <!-- Actions for owned games -->
                <div id="gp-owned-actions" class="space-y-2 hidden">
                    <button onclick="openEntryModalFor(previewGame)"
                        class="w-full py-3 rounded-xl btn-glow text-sm font-medium">
                        <i class="fa-solid fa-pen mr-2"></i>Add Journal Entry
                    </button>
                    <div class="grid grid-cols-2 gap-2">
                        <button onclick="quickRate(previewGame)"
                            class="py-2.5 rounded-xl bg-amber-500/10 text-amber-400 hover:bg-amber-500/20 text-sm font-medium">
                            <i class="fa-solid fa-star mr-1"></i>Rate
                        </button>
                        <button onclick="quickStatus(previewGame)"
                            class="py-2.5 rounded-xl bg-violet-500/10 text-violet-400 hover:bg-violet-500/20 text-sm font-medium">
                            <i class="fa-solid fa-tag mr-1"></i>Status
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="toast"
        class="fixed bottom-4 right-4 hidden bg-zinc-800/90 border border-zinc-700 rounded-lg px-4 py-2.5 text-sm z-50 backdrop-blur-sm">
    </div>

    <script>
        const API = '/.netlify/functions/game-logger-api';
        const RATING_LABELS = ['', 'Poor', 'Below Avg', 'Average', 'Good', 'Excellent'];
        const STATUSES = { backlog: 'Backlog', played: 'Played', finished: 'Finished', perfected: '100%', endless: 'Endless', on_hold: 'On Hold', dropped: 'Dropped' };
        const STATUS_CLASS = { backlog: 'status-backlog', played: 'status-played', finished: 'status-finished', perfected: 'status-perfected', endless: 'status-endless', on_hold: 'status-on_hold', dropped: 'status-dropped' };
        const GAME_RATINGS = { 10: 'Masterpiece', 9: 'Incredible', 8: 'Amazing', 7: 'Great', 6: 'Good', 5: 'Decent', 4: 'Meh', 3: 'Bad', 2: 'Terrible', 1: 'Trash' };

        let user = null, isOwner = false, currentView = 'library', filter = 'all', modalGame = null, pickingSlot = null, showAllClub = false;
        let entryRatings = { story: 0, gameplay: 0, graphics: 0, audio: 0 };
        let searchTimeout = null, searchPlatform = 'all';
        let libraryView = localStorage.getItem('libraryView') || 'list';
        const PLATFORM_ICONS = {
            steam: '<i class="fa-brands fa-steam"></i>',
            playstation: '<i class="fa-brands fa-playstation"></i>',
            xbox: '<i class="fa-brands fa-xbox"></i>',
            nintendo: '<i class="fa-solid fa-n"></i>',
            pc: '<i class="fa-solid fa-desktop"></i>',
            mobile: '<i class="fa-solid fa-mobile"></i>'
        };
        const GROUP_ORDER = ['played', 'playing', 'backlog', 'finished', 'perfected', 'endless', 'on_hold', 'dropped'];
        const GROUP_ICONS = { played: 'üéÆ', playing: '‚ñ∂Ô∏è', backlog: 'üìã', finished: '‚úÖ', perfected: 'üèÜ', endless: '‚ôæÔ∏è', on_hold: '‚è∏Ô∏è', dropped: '‚ùå' };

        const path = location.pathname.split('/').filter(Boolean);
        const urlUser = path[path.length - 1];
        const isMe = urlUser === 'me' || urlUser === 'profile.html';

        async function init() {
            try {
                const me = await (await fetch(`${API}?action=me`, { credentials: 'include' })).json();
                if (isMe) { if (!me.user) { location.href = '/game-logger/'; return; } user = me.user; isOwner = true; }
                else { const p = await (await fetch(`${API}?action=profile&username=${urlUser}`, { credentials: 'include' })).json(); if (p.error) { document.getElementById('loading').innerHTML = '<div class="text-center"><div class="text-5xl mb-4">üëæ</div><p>Not found</p></div>'; return; } user = p.user; isOwner = p.isOwner; }
                render(); document.getElementById('loading').classList.add('hidden');
            } catch (e) { console.error(e); }
        }

        function render() {
            document.getElementById('avatar').src = user.avatar;
            document.getElementById('display-name').textContent = user.displayName;
            document.getElementById('steam-info').innerHTML = user.steam ? `<a href="${user.steam.profileUrl}" target="_blank" class="hover:text-violet-400"><i class="fa-brands fa-steam mr-1"></i>${user.steam.personaName}</a>` : '';

            const games = (user.games || []).filter(g => !g.hidden);
            document.getElementById('stat-games').textContent = games.length;
            document.getElementById('stat-hours').textContent = Math.round(games.reduce((s, g) => s + (g.playtimeMinutes || 0), 0) / 60).toLocaleString();
            document.getElementById('stat-perfected').textContent = games.filter(g => g.status === 'perfected').length;
            document.getElementById('stat-entries').textContent = (user.journalEntries || []).length;

            // Extended stats
            const thisYear = new Date().getFullYear();
            const playedThisYear = games.filter(g => g.lastPlayed && new Date(g.lastPlayed).getFullYear() === thisYear).length;
            const backlogCount = games.filter(g => g.status === 'backlog').length;
            const wishlistCount = (user.wishlist || []).length;
            const masterpieces = games.filter(g => g.rating === 10).length;

            document.getElementById('stat-this-year').textContent = playedThisYear;
            document.getElementById('stat-backlog').textContent = backlogCount;
            document.getElementById('stat-wishlist').textContent = wishlistCount;
            document.getElementById('stat-masterpieces').textContent = masterpieces;

            // Ratings distribution chart (10 bars for ratings 1-10, displayed as half-stars 0.5-5)
            renderRatingsChart(games);

            // Level/XP System
            renderLevelSystem(games);

            if (isOwner) { document.getElementById('settings-btn').classList.remove('hidden'); document.getElementById('owner-actions').classList.remove('hidden'); }
            else { document.getElementById('owner-actions').classList.add('hidden'); }

            document.getElementById('nav-auth').innerHTML = user ? `<a href="/.netlify/functions/game-logger-api?action=logout" class="text-zinc-500 hover:text-zinc-300">Logout</a>` : '';

            renderFavorites(); renderClub(); renderRecentActivity(); renderGames(); renderJournal();
        }

        // === LEVEL/XP SYSTEM ===
        function renderLevelSystem(games) {
            // XP Calculation:
            // +10 XP per game with any status
            // +1 XP per hour played
            // +50 XP per 100% game
            // +25 XP per finished game
            // +5 XP per journal entry

            let xp = 0;
            xp += games.length * 10;
            xp += Math.floor(games.reduce((s, g) => s + (g.playtimeMinutes || 0), 0) / 60);
            xp += games.filter(g => g.status === 'perfected').length * 50;
            xp += games.filter(g => g.status === 'finished').length * 25;
            xp += (user.journalEntries || []).length * 5;

            // Level calculation (exponential)
            // Level 1: 0-100 XP, Level 2: 100-250 XP, etc.
            const levelThresholds = [0, 100, 250, 500, 1000, 2000, 4000, 7500, 12000, 20000, 35000, 60000, 100000];
            let level = 1;
            for (let i = 1; i < levelThresholds.length; i++) {
                if (xp >= levelThresholds[i]) level = i + 1;
                else break;
            }

            const currentLevelXP = levelThresholds[level - 1] || 0;
            const nextLevelXP = levelThresholds[level] || levelThresholds[levelThresholds.length - 1];
            const xpInLevel = xp - currentLevelXP;
            const xpNeeded = nextLevelXP - currentLevelXP;
            const progress = Math.min((xpInLevel / xpNeeded) * 100, 100);

            // Rank titles
            const ranks = ['Newcomer', 'Rookie', 'Apprentice', 'Player', 'Gamer', 'Expert', 'Veteran', 'Elite', 'Master', 'Legend', 'Mythic', 'Immortal', 'Divine'];
            const rank = ranks[Math.min(level - 1, ranks.length - 1)];

            document.getElementById('level-badge').textContent = `LVL ${level}`;
            document.getElementById('rank-title').textContent = rank;
            document.getElementById('xp-display').textContent = `${xp.toLocaleString()} / ${nextLevelXP.toLocaleString()} XP`;
            document.getElementById('xp-bar-fill').style.width = `${progress}%`;
        }

        // === TROPHY CABINET ===
        function renderTrophyCabinet(games) {
            const perfected = games.filter(g => g.status === 'perfected' || (g.achievements && g.achievements.percent === 100));

            if (perfected.length === 0) {
                document.getElementById('trophy-section').classList.add('hidden');
                return;
            }

            document.getElementById('trophy-section').classList.remove('hidden');

            const show = perfected.slice(0, 8);
            document.getElementById('trophy-list').innerHTML = show.map(g =>
                `<div class="trophy-item cursor-pointer flex items-center gap-2" onclick="openGameModal('${g.steamAppId || g.id}')">
                    <img src="${g.icon || g.headerImg}" class="w-8 h-8 rounded object-cover">
                    <div class="text-xs text-zinc-300 truncate max-w-[80px]">${g.name}</div>
                </div>`
            ).join('');
        }

        // === ACHIEVEMENT TOAST ===
        function showAchievementToast(title, description, icon = 'üèÜ') {
            // Remove existing toast
            document.getElementById('achievement-toast-container')?.remove();

            const container = document.createElement('div');
            container.id = 'achievement-toast-container';
            container.className = 'achievement-toast';
            container.innerHTML = `
                <div class="achievement-icon">${icon}</div>
                <div>
                    <div class="text-xs text-zinc-400 uppercase tracking-wide">Achievement Unlocked</div>
                    <div class="font-bold text-white">${title}</div>
                    <div class="text-xs text-zinc-400">${description}</div>
                </div>
            `;

            document.body.appendChild(container);

            // Trigger animation
            setTimeout(() => container.classList.add('show'), 50);

            // Auto hide
            setTimeout(() => {
                container.classList.remove('show');
                setTimeout(() => container.remove(), 500);
            }, 4000);
        }

        function renderRatingsChart(games) {
            const buckets = [0, 0, 0, 0, 0]; // 1‚òÖ, 2‚òÖ, 3‚òÖ, 4‚òÖ, 5‚òÖ
            let ratedCount = 0;

            games.forEach(g => {
                if (!g.rating || g.rating <= 0) return;
                ratedCount++;

                // Handle both formats:
                // - 1-10 scale (half-stars): divide by 2 and ceil
                // - 0.5-5 scale (decimals like 4.5): round to nearest int
                let starRating;
                if (g.rating > 5) {
                    // It's on 1-10 scale
                    starRating = Math.ceil(g.rating / 2);
                } else {
                    // It's on 0-5 scale (decimals like 4.2)
                    starRating = Math.round(g.rating);
                }

                if (starRating >= 1 && starRating <= 5) {
                    buckets[starRating - 1]++;
                }
            });

            console.log('Ratings chart:', { buckets, ratedCount });

            const max = Math.max(...buckets, 1);
            const chartEl = document.getElementById('ratings-chart');
            if (!chartEl) return;

            chartEl.innerHTML = buckets.map((count, i) => {
                const height = Math.max((count / max) * 100, count > 0 ? 15 : 5);
                const stars = (i + 1);
                return `<div class="w-6 bg-gradient-to-t from-violet-500 to-pink-400 rounded-sm relative group cursor-pointer" 
                     style="height: ${height}%"
                     title="${count} games">
                     <span class="absolute -top-4 left-1/2 -translate-x-1/2 text-[9px] text-zinc-400 opacity-0 group-hover:opacity-100">${count}</span>
                </div>`;
            }).join('');
        }

        function renderFavorites() {
            const slots = user.favoriteSlots || [null, null, null, null, null, null];
            let html = '';
            for (let i = 0; i < 6; i++) {
                const id = slots[i]; const g = id ? (user.games || []).find(x => (x.steamAppId == id || x.id == id) && !x.hidden) : null;
                if (g) { html += `<div class="fav-card" onclick="${isOwner ? `openFavModal(${i})` : `openGameModal('${g.steamAppId || g.id}')`}"><img src="${g.headerImg}" class="w-full h-full object-cover"><div class="absolute inset-0 bg-gradient-to-t from-black/70 to-transparent"></div><div class="absolute bottom-2 left-2 right-2 text-xs font-medium truncate">${g.name}</div></div>`; }
                else if (isOwner) { html += `<div class="fav-card empty flex items-center justify-center" onclick="openFavModal(${i})"><i class="fa-solid fa-plus text-pink-400/50"></i></div>`; }
            }
            document.getElementById('favorites-row').innerHTML = html;
        }

        function renderClub() {
            const perf = (user.games || []).filter(g => g.status === 'perfected' && !g.hidden);
            if (!perf.length || clubHidden) { document.getElementById('club-section').classList.add('hidden'); return; }
            document.getElementById('club-section').classList.remove('hidden');
            const show = showAllClub ? perf : perf.slice(0, 16);
            document.getElementById('club-toggle').textContent = showAllClub ? 'Less' : `All (${perf.length})`;
            document.getElementById('club-grid').innerHTML = show.map(g => `<div class="club-card h-14" onclick="openGameModal('${g.steamAppId || g.id}')"><img src="${g.headerImg}" class="w-full h-full object-cover"><span class="absolute bottom-1 left-2 right-2 text-[10px] font-medium truncate z-10">${g.name}</span></div>`).join('');
        }
        function toggleClub() { showAllClub = !showAllClub; renderClub(); }

        let clubHidden = localStorage.getItem('clubHidden') === 'true';
        function toggleClubVisibility() {
            clubHidden = !clubHidden;
            localStorage.setItem('clubHidden', clubHidden);
            renderClub();
            toast(clubHidden ? '100% Club hidden' : '100% Club shown');
        }

        function renderRecentActivity() {
            const entries = (user.journalEntries || []).slice().reverse();
            const recentGames = (user.games || []).filter(g => !g.hidden && g.lastPlayed)
                .sort((a, b) => new Date(b.lastPlayed) - new Date(a.lastPlayed))
                .slice(0, 4);

            let html = '';

            // Latest journal entry
            if (entries.length > 0) {
                const e = entries[0];
                const game = (user.games || []).find(g => g.steamAppId == e.gameId || g.id == e.gameId);
                if (game) {
                    const imgSrc = game.headerImg || game.icon || game.rawgData?.background_image || '';
                    html += `<div class="flex-shrink-0 w-48 bg-violet-500/10 border border-violet-500/20 rounded-xl p-3 cursor-pointer hover:bg-violet-500/20 transition" onclick="openGameModal('${game.steamAppId || game.id}')">
                        <div class="flex items-center gap-2 mb-2">
                            <img src="${imgSrc}" class="w-10 h-10 rounded-lg object-cover" onerror="this.src='https://via.placeholder.com/40?text=?'">
                            <div class="flex-1 min-w-0">
                                <div class="text-xs font-medium truncate text-white">${game.name}</div>
                                <div class="text-[10px] text-violet-400">Latest Journal</div>
                            </div>
                        </div>
                        ${e.thoughts ? `<p class="text-[10px] text-zinc-400 line-clamp-2">${e.thoughts}</p>` : ''}
                    </div>`;
                }
            }

            // Recently played games
            recentGames.forEach(g => {
                const lastPlayed = new Date(g.lastPlayed);
                const timeAgo = getTimeAgo(lastPlayed);
                const imgSrc = g.headerImg || g.icon || g.rawgData?.background_image || '';
                html += `<div class="flex-shrink-0 w-36 rounded-xl overflow-hidden cursor-pointer group" onclick="openGameModal('${g.steamAppId || g.id}')">
                    <div class="relative h-20">
                        <img src="${imgSrc}" class="w-full h-full object-cover group-hover:scale-105 transition duration-300" onerror="this.src='https://via.placeholder.com/144x80?text=No+Image'">
                        <div class="absolute inset-0 bg-gradient-to-t from-black/80 to-transparent"></div>
                        <div class="absolute bottom-2 left-2 right-2">
                            <div class="text-xs font-medium truncate text-white">${g.name}</div>
                            <div class="text-[9px] text-zinc-400">${timeAgo}</div>
                        </div>
                    </div>
                </div>`;
            });

            if (!html) {
                document.getElementById('recent-activity-section').classList.add('hidden');
            } else {
                document.getElementById('recent-activity-section').classList.remove('hidden');
                document.getElementById('recent-activity-row').innerHTML = html;
            }
        }

        function getTimeAgo(date) {
            const now = new Date();
            const diff = now - date;
            const mins = Math.floor(diff / 60000);
            const hours = Math.floor(diff / 3600000);
            const days = Math.floor(diff / 86400000);

            if (mins < 60) return `${mins}m ago`;
            if (hours < 24) return `${hours}h ago`;
            if (days < 7) return `${days}d ago`;
            return date.toLocaleDateString('en-GB', { day: 'numeric', month: 'short' });
        }

        function switchView(v) {
            currentView = v;
            document.querySelectorAll('.tab-btn').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.nav-link').forEach(n => n.classList.remove('active'));
            document.getElementById(`tab-${v}`)?.classList.add('active');
            document.getElementById(`nav-${v}`)?.classList.add('active');
            document.getElementById('view-library').classList.toggle('hidden', v !== 'library');
            document.getElementById('view-journal').classList.toggle('hidden', v !== 'journal');
            document.getElementById('view-wishlist').classList.toggle('hidden', v !== 'wishlist');
            document.getElementById('view-collections').classList.toggle('hidden', v !== 'collections');
            document.getElementById('library-controls').classList.toggle('hidden', v !== 'library');
            document.getElementById('journal-controls').classList.toggle('hidden', v !== 'journal');
            if (v === 'wishlist') renderWishlist();
            if (v === 'collections') renderCollections();
        }

        function filterGames(f) { filter = f; document.querySelectorAll('[id^="f-"]').forEach(b => b.classList.remove('active')); document.getElementById(`f-${f}`).classList.add('active'); renderGames(); }

        function setLibraryView(v) {
            libraryView = v;
            localStorage.setItem('libraryView', v);
            document.querySelectorAll('.view-toggle-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(`view-${v}`).classList.add('active');
            renderGames();
        }

        function isRecentlyPlayed(lastPlayed) {
            if (!lastPlayed) return { now: false, recent: false };
            const diff = Date.now() - new Date(lastPlayed).getTime();
            const hours = diff / (1000 * 60 * 60);
            return { now: hours < 24, recent: hours < 168 }; // 24h = now, 7 days = recent
        }

        function makeProgressRing(percent) {
            const r = 14, c = 2 * Math.PI * r;
            const offset = c - (percent / 100) * c;
            const isGold = percent === 100;
            return `<div class="progress-ring">
                <svg width="36" height="36"><circle class="ring-bg" cx="18" cy="18" r="${r}"/>
                <circle class="ring-fill ${isGold ? 'gold' : ''}" cx="18" cy="18" r="${r}" 
                    stroke-dasharray="${c}" stroke-dashoffset="${offset}"/></svg>
                <div class="progress-ring-text">${percent}%</div></div>`;
        }

        function makePlatformIcons(platforms) {
            if (!platforms || !platforms.length) return '';
            return `<div class="platform-icons">${platforms.slice(0, 3).map(p =>
                `<span class="platform-icon-small" title="${p}">${PLATFORM_ICONS[p.toLowerCase()] || p.charAt(0).toUpperCase()}</span>`
            ).join('')}</div>`;
        }

        function makeQuickActions(g) {
            // Removed - overlaps other elements and duplicates modal functionality
            return '';
        }

        // === MULTI-SELECT MODE ===
        let multiSelectMode = false;
        let selectedGames = new Set();

        function toggleMultiSelect() {
            multiSelectMode = !multiSelectMode;
            selectedGames.clear();
            document.getElementById('multiselect-toggle').classList.toggle('btn-glow', multiSelectMode);
            document.getElementById('multiselect-toggle').classList.toggle('bg-white/5', !multiSelectMode);
            document.getElementById('multiselect-bar').classList.toggle('hidden', !multiSelectMode);
            updateSelectionCount();
            renderGames();
        }

        function toggleGameSelection(id, event) {
            if (event) event.stopPropagation();
            if (!multiSelectMode) return;

            if (selectedGames.has(id)) {
                selectedGames.delete(id);
            } else {
                selectedGames.add(id);
            }
            updateSelectionCount();
            renderGames();
        }

        function updateSelectionCount() {
            document.getElementById('selected-count').textContent = selectedGames.size;
            // Show/hide bar based on selection
            if (multiSelectMode) {
                document.getElementById('multiselect-bar').classList.remove('hidden');
            }
        }

        function selectAllGames() {
            const games = (user.games || []).filter(g => !g.hidden);
            games.forEach(g => selectedGames.add(g.steamAppId || g.id));
            updateSelectionCount();
            renderGames();
        }

        function clearSelection() {
            selectedGames.clear();
            updateSelectionCount();
            renderGames();
        }

        async function bulkSetStatus(status) {
            if (selectedGames.size === 0) return;

            const ids = Array.from(selectedGames);
            const res = await fetch(`${API}?action=bulk-update`, {
                method: 'POST',
                credentials: 'include',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ steamAppIds: ids, status })
            });

            if ((await res.json()).success) {
                ids.forEach(id => {
                    const game = (user.games || []).find(g => (g.steamAppId || g.id) == id);
                    if (game) game.status = status;
                });
                clearSelection();
                toast(`Updated ${ids.length} games`);
            }
        }

        async function bulkHideGames() {
            if (selectedGames.size === 0) return;
            if (!confirm(`Hide ${selectedGames.size} games?`)) return;

            const ids = Array.from(selectedGames);
            for (const id of ids) {
                await saveGame(id, { hidden: true });
                const game = (user.games || []).find(g => (g.steamAppId || g.id) == id);
                if (game) game.hidden = true;
            }
            clearSelection();
            toast(`Hid ${ids.length} games`);
        }

        function renderGames() {
            let games = [...(user.games || [])].filter(g => !g.hidden);
            const search = document.getElementById('search-input').value.toLowerCase();
            const sort = document.getElementById('sort-select').value;
            if (filter !== 'all') games = games.filter(g => g.status === filter);
            if (search) games = games.filter(g => g.name.toLowerCase().includes(search));

            // Platform filter
            const platformFilter = document.getElementById('platform-filter')?.value || 'all';
            if (platformFilter !== 'all') {
                games = games.filter(g => (g.platforms || []).includes(platformFilter));
            }
            if (sort === 'name') games.sort((a, b) => a.name.localeCompare(b.name));
            else if (sort === 'recent') games.sort((a, b) => new Date(b.lastPlayed || 0) - new Date(a.lastPlayed || 0));
            else if (sort === 'rating') games.sort((a, b) => (b.rating || 0) - (a.rating || 0));
            else games.sort((a, b) => (b.playtimeMinutes || 0) - (a.playtimeMinutes || 0));

            // Hide all views first
            document.getElementById('games-list').classList.add('hidden');
            document.getElementById('games-grid').classList.add('hidden');
            document.getElementById('games-grouped').classList.add('hidden');
            document.getElementById('games-list').innerHTML = '';
            document.getElementById('games-grid').innerHTML = '';
            document.getElementById('games-grouped').innerHTML = '';

            if (!games.length) { document.getElementById('no-games').classList.remove('hidden'); return; }
            document.getElementById('no-games').classList.add('hidden');

            // Activate correct view toggle on load
            document.querySelectorAll('.view-toggle-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(`view-${libraryView}`)?.classList.add('active');

            if (libraryView === 'list') {
                document.getElementById('games-list').classList.remove('hidden');
                document.getElementById('games-list').innerHTML = games.map(g => renderListRow(g)).join('');
            } else if (libraryView === 'grid') {
                document.getElementById('games-grid').classList.remove('hidden');
                document.getElementById('games-grid').innerHTML = games.map(g => renderGridCard(g)).join('');
            } else if (libraryView === 'grouped') {
                document.getElementById('games-grouped').classList.remove('hidden');
                renderGroupedView(games);
            }
        }

        function renderListViewStars(rating) {
            // rating is 1-10, display as compact badge with tier
            const score = (rating / 2).toFixed(1);

            // Gamery tier labels
            const tiers = {
                10: { label: 'S', tier: 'S-Tier', color: 'from-amber-400 to-yellow-500', text: 'text-amber-300' },
                9: { label: 'S', tier: 'S-Tier', color: 'from-amber-400 to-yellow-500', text: 'text-amber-300' },
                8: { label: 'A', tier: 'A-Tier', color: 'from-green-400 to-emerald-500', text: 'text-green-400' },
                7: { label: 'A', tier: 'A-Tier', color: 'from-green-400 to-emerald-500', text: 'text-green-400' },
                6: { label: 'B', tier: 'B-Tier', color: 'from-blue-400 to-cyan-500', text: 'text-blue-400' },
                5: { label: 'C', tier: 'C-Tier', color: 'from-zinc-400 to-zinc-500', text: 'text-zinc-400' },
                4: { label: 'C', tier: 'C-Tier', color: 'from-zinc-400 to-zinc-500', text: 'text-zinc-400' },
                3: { label: 'D', tier: 'D-Tier', color: 'from-orange-400 to-red-500', text: 'text-orange-400' },
                2: { label: 'F', tier: 'F-Tier', color: 'from-red-500 to-red-600', text: 'text-red-400' },
                1: { label: 'F', tier: 'F-Tier', color: 'from-red-500 to-red-600', text: 'text-red-400' }
            };

            const tier = tiers[rating] || tiers[5];

            return `<div class="flex items-center gap-2">
                <div class="w-7 h-7 rounded-lg bg-gradient-to-br ${tier.color} flex items-center justify-center font-bold text-sm text-black shadow-lg">${tier.label}</div>
                <span class="${tier.text} text-sm font-medium">${score}</span>
                <span class="text-[9px] px-1.5 py-0.5 rounded bg-white/5 ${tier.text}">${tier.tier}</span>
            </div>`;
        }

        function renderListRow(g) {
            const hours = Math.round((g.playtimeMinutes || 0) / 60);
            const recent = isRecentlyPlayed(g.lastPlayed);
            const ratingStars = g.rating ? renderListViewStars(g.rating) : '';
            const achRing = g.achievements ? makeProgressRing(g.achievements.percent) : '';
            const platforms = makePlatformIcons(g.platforms);
            const quickActions = makeQuickActions(g);
            const recentBadge = recent.now ? '<span class="now-playing-badge">Now</span>' : '';
            const rowClass = recent.recent && !recent.now ? 'recent-glow' : '';
            const gameId = g.steamAppId || g.id;
            const isSelected = selectedGames.has(gameId);

            // Recent playtime indicator (last 2 weeks)
            const recentHours = g.playtimeRecent ? Math.round(g.playtimeRecent / 60) : 0;
            const recentMins = g.playtimeRecent ? g.playtimeRecent % 60 : 0;
            const recentIndicator = recentHours > 0 || recentMins > 30
                ? `<span class="recent-playtime-badge"><i class="fa-solid fa-arrow-up"></i> +${recentHours > 0 ? recentHours + 'h' : recentMins + 'm'}</span>`
                : '';

            // Multi-select checkbox
            const checkbox = multiSelectMode
                ? `<div class="mr-3 flex-shrink-0" onclick="toggleGameSelection('${gameId}', event)">
                    <div class="w-5 h-5 rounded border ${isSelected ? 'bg-violet-500 border-violet-500' : 'border-zinc-600'} flex items-center justify-center cursor-pointer">
                        ${isSelected ? '<i class="fa-solid fa-check text-white text-xs"></i>' : ''}
                    </div>
                </div>`
                : '';

            const clickHandler = multiSelectMode
                ? `onclick="toggleGameSelection('${gameId}', event)"`
                : `onclick="openGameModal('${gameId}')"`;

            return `<div class="game-row ${rowClass} ${isSelected ? 'bg-violet-500/10 border-violet-500/30' : ''}" ${clickHandler}>
                ${checkbox}
                <img src="${g.icon || g.headerImg}" class="w-10 h-10 rounded-lg object-cover" onerror="this.src='https://via.placeholder.com/40'">
                <div class="flex-1 min-w-0">
                    <div class="font-medium text-sm truncate">${g.name}</div>
                    <div class="text-xs text-zinc-500">${hours}h${g.lastPlayed ? ' ¬∑ ' + new Date(g.lastPlayed).toLocaleDateString('en-GB', { day: 'numeric', month: 'short', year: 'numeric' }) : ''}</div>
                </div>
                ${recentIndicator}
                ${platforms}
                ${ratingStars}
                ${achRing}
                <a href="game.html?id=${gameId}" onclick="event.stopPropagation()" class="text-zinc-500 hover:text-violet-400 px-2" title="Open game page"><i class="fa-solid fa-arrow-up-right-from-square text-xs"></i></a>
                ${quickActions}
                <span class="status-badge ${STATUS_CLASS[g.status] || 'status-played'}">${STATUSES[g.status] || 'Played'}</span>
                ${recentBadge}
            </div>`;
        }

        function renderGridCard(g) {
            const hours = Math.round((g.playtimeMinutes || 0) / 60);
            const recent = isRecentlyPlayed(g.lastPlayed);
            const ratingBadge = g.rating ? renderTierBadge(g.rating) : '';
            const achRing = g.achievements ? makeProgressRing(g.achievements.percent) : '';
            const platforms = makePlatformIcons(g.platforms);
            const recentBadge = recent.now ? '<span class="now-playing-badge absolute top-2 right-2">Now</span>' : '';

            return `<div class="game-card" onclick="openGameModal('${g.steamAppId || g.id}')">
                <img src="${g.headerImg || g.icon}" class="game-card-img" onerror="this.src='https://via.placeholder.com/200x100'">
                ${recentBadge}
                <div class="game-card-body">
                    <div class="game-card-title">${g.name}</div>
                    <div class="game-card-meta">
                        <span>‚è±Ô∏è ${hours}h</span>
                        ${platforms}
                    </div>
                    <div class="game-card-footer">
                        <div class="flex items-center gap-2">
                            ${ratingBadge}
                            ${achRing}
                        </div>
                        <span class="status-badge ${STATUS_CLASS[g.status] || 'status-played'}">${STATUSES[g.status] || 'Played'}</span>
                    </div>
                </div>
            </div>`;
        }

        function renderTierBadge(rating) {
            const tiers = {
                10: { label: 'S', color: 'from-amber-400 to-yellow-500' },
                9: { label: 'S', color: 'from-amber-400 to-yellow-500' },
                8: { label: 'A', color: 'from-green-400 to-emerald-500' },
                7: { label: 'A', color: 'from-green-400 to-emerald-500' },
                6: { label: 'B', color: 'from-blue-400 to-cyan-500' },
                5: { label: 'C', color: 'from-zinc-400 to-zinc-500' },
                4: { label: 'C', color: 'from-zinc-400 to-zinc-500' },
                3: { label: 'D', color: 'from-orange-400 to-red-500' },
                2: { label: 'F', color: 'from-red-500 to-red-600' },
                1: { label: 'F', color: 'from-red-500 to-red-600' }
            };
            const tier = tiers[rating] || tiers[5];
            const score = (rating / 2).toFixed(1);
            return `<div class="flex items-center gap-1">
                <div class="w-5 h-5 rounded bg-gradient-to-br ${tier.color} flex items-center justify-center font-bold text-[10px] text-black">${tier.label}</div>
                <span class="text-xs text-zinc-400">${score}</span>
            </div>`;
        }

        function renderGroupedView(games) {
            const groups = {};
            games.forEach(g => {
                const status = g.status || 'played';
                if (!groups[status]) groups[status] = [];
                groups[status].push(g);
            });

            let html = '';
            GROUP_ORDER.forEach(status => {
                if (!groups[status] || !groups[status].length) return;
                const label = STATUSES[status] || status;
                const icon = GROUP_ICONS[status] || 'üéÆ';
                const count = groups[status].length;
                html += `<div class="group-section">
                    <div class="group-header" onclick="toggleGroup('${status}')">
                        <h3><span>${icon}</span> ${label} <span class="group-count">${count}</span></h3>
                        <i class="fa-solid fa-chevron-down group-chevron" id="chevron-${status}"></i>
                    </div>
                    <div class="group-games" id="group-${status}">
                        ${groups[status].map(g => renderListRow(g)).join('')}
                    </div>
                </div>`;
            });
            document.getElementById('games-grouped').innerHTML = html;
        }

        function toggleGroup(status) {
            const games = document.getElementById(`group-${status}`);
            const chevron = document.getElementById(`chevron-${status}`);
            const header = chevron.closest('.group-header');
            if (games.classList.contains('collapsed')) {
                games.classList.remove('collapsed');
                games.style.maxHeight = games.scrollHeight + 'px';
                header.classList.remove('collapsed');
            } else {
                games.classList.add('collapsed');
                games.style.maxHeight = '0';
                header.classList.add('collapsed');
            }
        }

        function quickRate(id) {
            const g = (user.games || []).find(x => x.steamAppId == id || x.id == id);
            if (g) { modalGame = g; openGameModal(id); }
        }
        function quickJournal(id) {
            const g = (user.games || []).find(x => x.steamAppId == id || x.id == id);
            if (g) {
                openEntryModal();
                setTimeout(() => { document.getElementById('entry-game').value = id; }, 50);
            }
        }
        function quickStatus(id) {
            const g = (user.games || []).find(x => x.steamAppId == id || x.id == id);
            if (g) { modalGame = g; openGameModal(id); }
        }

        function renderJournal() {
            const entries = (user.journalEntries || []).slice().reverse();
            if (!entries.length) {
                document.getElementById('journal-list').innerHTML = '';
                document.getElementById('no-entries').classList.remove('hidden');
                return;
            }
            document.getElementById('no-entries').classList.add('hidden');

            // Group entries by month
            const grouped = {};
            entries.forEach((e, displayIdx) => {
                const dateStr = e.date || (e.endTime ? new Date(e.endTime).toISOString().split('T')[0] : new Date().toISOString().split('T')[0]);
                const date = new Date(dateStr);
                const monthKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
                const monthLabel = date.toLocaleDateString('en-GB', { month: 'long', year: 'numeric' });

                if (!grouped[monthKey]) {
                    grouped[monthKey] = { label: monthLabel, entries: [] };
                }
                grouped[monthKey].entries.push({ ...e, realIdx: entries.length - 1 - displayIdx, displayDate: dateStr });
            });

            // Sort months descending (newest first)
            const sortedMonths = Object.keys(grouped).sort().reverse();

            let html = '';
            sortedMonths.forEach(monthKey => {
                const month = grouped[monthKey];

                html += `<div class="mb-10">
                    <div class="flex items-center gap-3 mb-5 pb-3 border-b border-violet-500/20">
                        <div class="w-2 h-2 rounded-full bg-violet-500"></div>
                        <h3 class="text-lg font-bold text-white tracking-wide">${month.label}</h3>
                        <span class="text-xs text-zinc-600 ml-auto">${month.entries.length} ${month.entries.length === 1 ? 'session' : 'sessions'}</span>
                    </div>
                    <div class="space-y-1">`;

                month.entries.forEach(e => {
                    const game = (user.games || []).find(g => g.steamAppId == e.gameId || g.id == e.gameId);
                    const isAuto = e.autoGenerated;

                    const date = new Date(e.displayDate);
                    const dayNum = date.getDate();
                    const dayName = date.toLocaleDateString('en-GB', { weekday: 'short' });

                    let durationStr = '';
                    if (e.sessionMinutes) {
                        const hrs = Math.floor(e.sessionMinutes / 60);
                        const mins = e.sessionMinutes % 60;
                        durationStr = hrs > 0 ? `${hrs}h ${mins}m` : `${mins}m`;
                    }

                    const statusColors = {
                        playing: 'text-green-400',
                        finished: 'text-emerald-400',
                        perfected: 'text-amber-400',
                        dropped: 'text-red-400',
                        on_hold: 'text-orange-400',
                        backlog: 'text-zinc-400'
                    };
                    const statusIcons = {
                        playing: 'fa-play',
                        finished: 'fa-check',
                        perfected: 'fa-trophy',
                        dropped: 'fa-times',
                        on_hold: 'fa-pause'
                    };

                    // Calculate rating display
                    const ratingValues = Object.values(e.ratings || {}).filter(v => v > 0);
                    const avgRating = ratingValues.length ? (ratingValues.reduce((a, b) => a + b, 0) / ratingValues.length / 2).toFixed(1) : null;

                    const editBtn = isOwner ? `<button onclick="event.stopPropagation();editJournalEntry(${e.realIdx})" class="opacity-0 group-hover:opacity-100 transition text-zinc-600 hover:text-violet-400 px-2"><i class="fa-solid fa-pencil text-xs"></i></button>` : '';

                    const gameLink = game ? `onclick="openGameModal('${game.steamAppId || game.id}')"` : '';

                    html += `<div class="group flex items-center gap-4 py-3 px-4 -mx-4 hover:bg-white/[0.02] rounded-lg cursor-pointer transition" ${gameLink}>
                        <!-- Date Column -->
                        <div class="w-14 flex-shrink-0 text-center">
                            <div class="text-xl font-bold text-zinc-300">${dayNum}</div>
                            <div class="text-[10px] text-zinc-600 uppercase tracking-wider">${dayName}</div>
                        </div>
                        
                        <!-- Game Image -->
                        ${game ? `<img src="${game.icon || game.headerImg}" class="w-12 h-12 rounded-md object-cover flex-shrink-0 ring-1 ring-white/5">` : '<div class="w-12 h-12 rounded-md bg-zinc-800/50 flex items-center justify-center text-zinc-700 flex-shrink-0"><i class="fa-solid fa-gamepad"></i></div>'}
                        
                        <!-- Main Content -->
                        <div class="flex-1 min-w-0">
                            <div class="flex items-center gap-2">
                                <span class="font-medium text-white truncate">${game?.name || 'Unknown Game'}</span>
                                ${isAuto ? '<span class="text-[9px] px-1.5 py-0.5 rounded-sm bg-cyan-500/10 text-cyan-500 font-medium">AUTO</span>' : ''}
                            </div>
                            ${e.thoughts ? `<p class="text-xs text-zinc-500 truncate mt-0.5">${e.thoughts}</p>` : ''}
                        </div>
                        
                        <!-- Stats -->
                        <div class="flex items-center gap-4 flex-shrink-0">
                            ${durationStr ? `<div class="text-xs text-zinc-400 w-16 text-right"><i class="fa-solid fa-clock mr-1 text-zinc-600"></i>${durationStr}</div>` : '<div class="w-16"></div>'}
                            
                            ${e.sessionStatus && statusIcons[e.sessionStatus] ? `<div class="w-8 h-8 rounded-full bg-white/5 flex items-center justify-center ${statusColors[e.sessionStatus] || 'text-zinc-500'}"><i class="fa-solid ${statusIcons[e.sessionStatus]} text-xs"></i></div>` : '<div class="w-8"></div>'}
                            
                            ${avgRating ? `<div class="flex items-center gap-1 text-amber-400 w-12"><i class="fa-solid fa-star text-[10px]"></i><span class="text-sm font-medium">${avgRating}</span></div>` : '<div class="w-12"></div>'}
                            
                            ${editBtn}
                        </div>
                    </div>`;
                });

                html += `</div></div>`;
            });

            document.getElementById('journal-list').innerHTML = html;
        }

        // Game Modal
        const DEFAULT_PLATFORMS = [
            { id: 'steam', name: 'Steam', icon: '<i class="fa-brands fa-steam"></i>' },
            { id: 'playstation', name: 'PlayStation', icon: '<i class="fa-brands fa-playstation"></i>' },
            { id: 'xbox', name: 'Xbox', icon: '<i class="fa-brands fa-xbox"></i>' },
            { id: 'nintendo', name: 'Nintendo', icon: '<i class="fa-solid fa-n"></i>' },
            { id: 'pc', name: 'PC', icon: '<i class="fa-solid fa-desktop"></i>' },
            { id: 'mobile', name: 'Mobile', icon: '<i class="fa-solid fa-mobile"></i>' }
        ];

        function openGameModal(id) {
            const g = (user.games || []).find(x => x.steamAppId == id || x.id == id); if (!g) return;
            modalGame = g;
            document.getElementById('gm-header').src = g.headerImg;
            document.getElementById('gm-icon').src = g.icon || g.headerImg;
            document.getElementById('gm-title').textContent = g.name;
            document.getElementById('gm-meta').textContent = `${Math.round((g.playtimeMinutes || 0) / 60)}h${g.achievements ? ' ¬∑ ' + g.achievements.percent + '%' : ''}`;
            if (isOwner) {
                document.getElementById('gm-controls').classList.remove('hidden');
                document.getElementById('gm-status').innerHTML = Object.entries(STATUSES).map(([k, v]) => `<button onclick="setGameStatus('${k}')" class="text-xs px-3 py-1.5 rounded-lg transition ${g.status === k ? 'btn-glow' : 'bg-white/5 text-zinc-400 hover:bg-white/10'}">${v}</button>`).join('');

                // Category ratings - stored as categoryRatings object with values 0-10 (0=no rating, 1-10 = half-star increments)
                gameRatings = g.categoryRatings || { story: 0, gameplay: 0, graphics: 0, audio: 0 };
                gameCategoryEnabled = g.categoryEnabled || { story: true, gameplay: true, graphics: true, audio: true };
                renderGameCategoryRatings();
                updateGameOverallRating();

                document.getElementById('gm-favorite').checked = !!g.favorite;
                document.getElementById('gm-hidden').checked = !!g.hidden;
                document.getElementById('gm-notes').value = g.notes || '';
                document.getElementById('gm-completed').value = g.completedAt || '';
                renderPlatformPicker(g);

                // Backlog priority section
                const prioritySection = document.getElementById('gm-priority-section');
                if (g.status === 'backlog') {
                    prioritySection.classList.remove('hidden');
                    updatePriorityButtons(g.priority || 0);
                } else {
                    prioritySection.classList.add('hidden');
                }
            } else { document.getElementById('gm-controls').classList.add('hidden'); }
            document.getElementById('game-modal').classList.remove('hidden');
        }

        function updatePriorityButtons(priority) {
            document.querySelectorAll('.priority-btn').forEach(btn => {
                const p = parseInt(btn.dataset.priority);
                if (p === priority) {
                    btn.classList.add('ring-2', 'ring-offset-2', 'ring-offset-zinc-900');
                    if (p === 3) btn.classList.add('ring-red-500');
                    else if (p === 2) btn.classList.add('ring-amber-500');
                    else if (p === 1) btn.classList.add('ring-blue-500');
                    else btn.classList.add('ring-white/50');
                } else {
                    btn.classList.remove('ring-2', 'ring-offset-2', 'ring-offset-zinc-900', 'ring-red-500', 'ring-amber-500', 'ring-blue-500', 'ring-white/50');
                }
            });
        }

        async function setGamePriority(priority) {
            if (!modalGame) return;
            modalGame.priority = priority;
            updatePriorityButtons(priority);
            await saveGameProp('priority', priority);
            toast(priority > 0 ? 'Priority set' : 'Priority removed');
        }

        function openGamePage() {
            if (!modalGame) return;
            const id = modalGame.steamAppId || modalGame.id;
            location.href = `game.html?id=${id}`;
        }

        function clearCompletedDate() {
            document.getElementById('gm-completed').value = '';
            saveGameProp('completedAt', null);
        }

        function renderPlatformPicker(g) {
            const gamePlatforms = g.platforms || [];
            const customPlatforms = user.customPlatforms || [];
            const allPlatforms = [...DEFAULT_PLATFORMS, ...customPlatforms];

            document.getElementById('gm-platforms').innerHTML = allPlatforms.map(p => {
                const isActive = gamePlatforms.includes(p.id);
                const iconHtml = p.icon.startsWith('<') ? p.icon : `<span>${p.icon}</span>`;
                return `<button onclick="togglePlatform('${p.id}')" class="flex items-center gap-2 px-3 py-1.5 rounded-lg text-xs font-medium transition ${isActive ? 'bg-gradient-to-r from-violet-500/30 to-pink-500/30 text-white border border-violet-400/40' : 'bg-white/5 text-zinc-400 hover:bg-white/10'}">
                    ${iconHtml} ${p.name}
                    ${!DEFAULT_PLATFORMS.find(d => d.id === p.id) ? `<span onclick="event.stopPropagation();deleteCustomPlatform('${p.id}')" class="ml-1 hover:text-red-400">√ó</span>` : ''}
                </button>`;
            }).join('');
        }

        async function togglePlatform(platformId) {
            if (!modalGame) return;
            const platforms = modalGame.platforms || [];
            const idx = platforms.indexOf(platformId);
            if (idx > -1) platforms.splice(idx, 1);
            else platforms.push(platformId);
            modalGame.platforms = platforms;

            const i = (user.games || []).findIndex(g => g.steamAppId == modalGame.steamAppId || g.id == modalGame.id);
            if (i > -1) user.games[i].platforms = platforms;

            await saveGame(modalGame.steamAppId || modalGame.id, { platforms });
            renderPlatformPicker(modalGame);
            renderGames();
        }

        async function addCustomPlatform() {
            const input = document.getElementById('custom-platform-name');
            const name = input.value.trim();
            if (!name) return;

            const res = await fetch(`${API}?action=custom-platforms`, {
                method: 'POST',
                credentials: 'include',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ name, icon: 'üéÆ' })
            });
            const data = await res.json();
            if (data.success) {
                user.customPlatforms = data.platforms;
                input.value = '';
                if (modalGame) renderPlatformPicker(modalGame);
                toast('Platform added!');
            }
        }

        async function deleteCustomPlatform(id) {
            if (!confirm('Delete this custom platform?')) return;
            const res = await fetch(`${API}?action=custom-platforms`, {
                method: 'DELETE',
                credentials: 'include',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ id })
            });
            const data = await res.json();
            if (data.success) {
                user.customPlatforms = data.platforms;
                if (modalGame) renderPlatformPicker(modalGame);
                renderGames();
                toast('Platform deleted');
            }
        }

        function closeGameModal() { document.getElementById('game-modal').classList.add('hidden'); modalGame = null; }
        async function setGameStatus(s) { if (!modalGame) return; modalGame.status = s; const i = (user.games || []).findIndex(g => g.steamAppId == modalGame.steamAppId || g.id == modalGame.id); if (i > -1) user.games[i].status = s; await saveGame(modalGame.steamAppId || modalGame.id, { status: s }); openGameModal(modalGame.steamAppId || modalGame.id); render(); }
        async function setGameRating(r) {
            if (!modalGame) return;
            modalGame.rating = r;
            const i = (user.games || []).findIndex(g => g.steamAppId == modalGame.steamAppId || g.id == modalGame.id);
            if (i > -1) user.games[i].rating = r;
            await saveGame(modalGame.steamAppId || modalGame.id, { rating: r });
            document.getElementById('gm-rating').innerHTML = renderHalfStarRating(r);
            document.getElementById('gm-rating-label').textContent = `${(r / 2).toFixed(1)} / 5`;
            renderGames();
        }

        // === GAME CATEGORY RATING SYSTEM ===
        let gameRatings = { story: 0, gameplay: 0, graphics: 0, audio: 0 };
        let gameCategoryEnabled = { story: true, gameplay: true, graphics: true, audio: true };
        const RATING_LABELS_10 = { 10: 'Masterpiece', 9: 'Excellent', 8: 'Great', 7: 'Good', 6: 'Decent', 5: 'Average', 4: 'Below Avg', 3: 'Poor', 2: 'Bad', 1: 'Terrible' };

        function renderGameCategoryRatings() {
            ['story', 'gameplay', 'graphics', 'audio'].forEach(cat => {
                const container = document.getElementById(`gm-cat-${cat}`);
                const toggle = document.getElementById(`gm-cat-${cat}-toggle`);
                const rating = gameRatings[cat] || 0;
                const enabled = gameCategoryEnabled[cat];

                toggle.checked = enabled;
                container.classList.toggle('disabled', !enabled);

                // Render 5 stars with half-star capability (click left = half, right = full)
                let html = '';
                for (let star = 1; star <= 5; star++) {
                    const halfValue = star * 2 - 1;
                    const fullValue = star * 2;
                    let starClass = 'cat-star';
                    if (rating >= fullValue) starClass += ' active';
                    else if (rating >= halfValue) starClass += ' half';

                    html += `<span class="${starClass}" onclick="setGameCategoryRating('${cat}', event, ${star})">‚òÖ</span>`;
                }
                container.innerHTML = html;
            });
        }

        function setGameCategoryRating(cat, event, star) {
            // Detect half-star click based on click position
            const rect = event.target.getBoundingClientRect();
            const isHalf = (event.clientX - rect.left) < (rect.width / 2);
            const value = isHalf ? (star * 2 - 1) : (star * 2);

            gameRatings[cat] = value;
            renderGameCategoryRatings();
            updateGameOverallRating();
            saveGameCategoryRatings();
        }

        function toggleGameCategory(cat) {
            gameCategoryEnabled[cat] = !gameCategoryEnabled[cat];
            renderGameCategoryRatings();
            updateGameOverallRating();
            saveGameCategoryRatings();
        }

        function updateGameOverallRating() {
            const enabledCats = Object.keys(gameCategoryEnabled).filter(k => gameCategoryEnabled[k] && gameRatings[k] > 0);

            if (enabledCats.length === 0) {
                document.getElementById('gm-overall-stars').innerHTML = '<span class="text-zinc-500">‚Äî</span>';
                document.getElementById('gm-overall-value').textContent = '';
                return;
            }

            const total = enabledCats.reduce((sum, cat) => sum + gameRatings[cat], 0);
            const avg = total / enabledCats.length;
            const rounded = Math.round(avg);

            // Display as X.X / 5
            const displayVal = (avg / 2).toFixed(1);
            const fullStars = Math.floor(rounded / 2);
            const hasHalf = rounded % 2 === 1;

            let starsHtml = '';
            for (let i = 0; i < fullStars; i++) starsHtml += '<i class="fa-solid fa-star"></i>';
            if (hasHalf) starsHtml += '<i class="fa-solid fa-star-half-stroke"></i>';
            for (let i = fullStars + (hasHalf ? 1 : 0); i < 5; i++) starsHtml += '<i class="fa-regular fa-star text-zinc-600"></i>';

            document.getElementById('gm-overall-stars').innerHTML = starsHtml;
            document.getElementById('gm-overall-value').textContent = `${displayVal}/5`;

            // Also show label
            const label = RATING_LABELS_10[rounded] || '';
            if (label) {
                document.getElementById('gm-overall-value').textContent += ` (${label})`;
            }
        }

        function clearGameRatings() {
            gameRatings = { story: 0, gameplay: 0, graphics: 0, audio: 0 };
            renderGameCategoryRatings();
            updateGameOverallRating();
            saveGameCategoryRatings();
        }

        async function saveGameCategoryRatings() {
            if (!modalGame) return;

            // Calculate overall rating (1-10 scale for storage)
            const enabledCats = Object.keys(gameCategoryEnabled).filter(k => gameCategoryEnabled[k] && gameRatings[k] > 0);
            const overall = enabledCats.length > 0
                ? Math.round(enabledCats.reduce((sum, cat) => sum + gameRatings[cat], 0) / enabledCats.length)
                : 0;

            modalGame.categoryRatings = { ...gameRatings };
            modalGame.categoryEnabled = { ...gameCategoryEnabled };
            modalGame.rating = overall;

            const i = (user.games || []).findIndex(g => g.steamAppId == modalGame.steamAppId || g.id == modalGame.id);
            if (i > -1) {
                user.games[i].categoryRatings = modalGame.categoryRatings;
                user.games[i].categoryEnabled = modalGame.categoryEnabled;
                user.games[i].rating = overall;
            }

            await saveGame(modalGame.steamAppId || modalGame.id, {
                categoryRatings: modalGame.categoryRatings,
                categoryEnabled: modalGame.categoryEnabled,
                rating: overall
            });
            renderGames();
        }

        async function saveGameProp(p, v) { if (!modalGame) return; modalGame[p] = v; const i = (user.games || []).findIndex(g => g.steamAppId == modalGame.steamAppId || g.id == modalGame.id); if (i > -1) user.games[i][p] = v; await saveGame(modalGame.steamAppId || modalGame.id, { [p]: v }); if (p === 'favorite') renderFavorites(); }
        async function saveGame(id, data) { await fetch(`${API}?action=update-game`, { method: 'POST', credentials: 'include', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ steamAppId: id, ...data }) }); }

        // Favorite Modal
        function openFavModal(s) { pickingSlot = s; document.getElementById('fav-search').value = ''; renderFavList(); document.getElementById('fav-modal').classList.remove('hidden'); }
        function closeFavModal() { document.getElementById('fav-modal').classList.add('hidden'); pickingSlot = null; }
        function renderFavList() { const search = document.getElementById('fav-search').value.toLowerCase(); const games = (user.games || []).filter(g => !g.hidden && g.name.toLowerCase().includes(search)).slice(0, 12); document.getElementById('fav-list').innerHTML = games.map(g => `<div class="flex items-center gap-3 p-2 rounded-lg hover:bg-white/5 cursor-pointer" onclick="selectFav('${g.steamAppId || g.id}')"><img src="${g.icon || g.headerImg}" class="w-8 h-8 rounded object-cover"><span class="text-sm truncate">${g.name}</span></div>`).join('') || '<p class="text-zinc-500 text-sm text-center py-4">No games</p>'; }
        async function selectFav(id) { const slots = user.favoriteSlots || [null, null, null, null, null, null]; slots[pickingSlot] = id; user.favoriteSlots = slots; await fetch(`${API}?action=set-favorite-slots`, { method: 'POST', credentials: 'include', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ slots }) }); closeFavModal(); renderFavorites(); toast('Updated'); }
        async function clearFavSlot() { const slots = user.favoriteSlots || [null, null, null, null, null, null]; slots[pickingSlot] = null; user.favoriteSlots = slots; await fetch(`${API}?action=set-favorite-slots`, { method: 'POST', credentials: 'include', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ slots }) }); closeFavModal(); renderFavorites(); }

        // Journal Entry Modal
        function openEntryModal() {
            editingEntryIndex = null; // Reset edit mode
            document.getElementById('entry-submit-text').textContent = 'Save Entry';
            document.getElementById('entry-game').value = '';
            document.getElementById('entry-game-search').value = '';
            document.getElementById('entry-game-selected').classList.add('hidden');
            document.getElementById('entry-game-list').classList.add('hidden');
            document.getElementById('entry-date').value = new Date().toISOString().split('T')[0];
            document.getElementById('entry-hours').value = '';
            document.getElementById('entry-mins').value = '';
            document.getElementById('entry-status').value = 'playing';
            document.getElementById('entry-thoughts').value = '';
            document.getElementById('entry-discoveries').value = '';
            entryRatings = { story: 0, gameplay: 0, graphics: 0, audio: 0 };
            renderEntryStars();
            document.getElementById('entry-modal').classList.remove('hidden');
        }

        function saveOrUpdateEntry() {
            if (editingEntryIndex !== null) {
                updateJournalEntry();
            } else {
                submitEntry();
            }
        }

        function filterEntryGames() {
            const search = document.getElementById('entry-game-search').value.toLowerCase();
            const games = (user.games || []).filter(g => !g.hidden && g.name.toLowerCase().includes(search)).slice(0, 10);
            const list = document.getElementById('entry-game-list');
            list.innerHTML = games.map(g => `
                <div class="flex items-center gap-3 p-2 hover:bg-white/5 cursor-pointer" onclick="selectEntryGame('${g.steamAppId || g.id}')">
                    <img src="${g.icon || g.headerImg}" class="w-8 h-8 rounded object-cover" onerror="this.src='https://via.placeholder.com/32'">
                    <span class="text-sm truncate">${g.name}</span>
                </div>
            `).join('') || '<p class="text-zinc-500 text-sm text-center py-4">No games found</p>';
            list.classList.remove('hidden');
        }

        function showEntryGameList() {
            filterEntryGames();
        }

        function selectEntryGame(id) {
            const game = (user.games || []).find(g => g.steamAppId == id || g.id == id);
            if (!game) return;
            document.getElementById('entry-game').value = id;
            document.getElementById('entry-game-search').value = '';
            document.getElementById('entry-game-list').classList.add('hidden');
            document.getElementById('entry-game-selected').classList.remove('hidden');
            document.getElementById('entry-game-icon').src = game.icon || game.headerImg;
            document.getElementById('entry-game-name').textContent = game.name;
        }

        function clearEntryGame() {
            document.getElementById('entry-game').value = '';
            document.getElementById('entry-game-selected').classList.add('hidden');
            document.getElementById('entry-game-search').focus();
        }

        // Close dropdown when clicking outside
        document.addEventListener('click', e => {
            if (!e.target.closest('#entry-game-search') && !e.target.closest('#entry-game-list')) {
                document.getElementById('entry-game-list')?.classList.add('hidden');
            }
        });

        function closeEntryModal() { document.getElementById('entry-modal').classList.add('hidden'); editingEntryIndex = null; }

        // Journal Entry Rating Functions (half-star support)
        function renderEntryStars() {
            document.querySelectorAll('.entry-rating-stars').forEach(c => {
                const cat = c.dataset.r;
                const rating = entryRatings[cat] || 0;

                let html = '';
                for (let star = 1; star <= 5; star++) {
                    const halfValue = star * 2 - 1;
                    const fullValue = star * 2;
                    let starClass = 'cat-star';
                    if (rating >= fullValue) starClass += ' active';
                    else if (rating >= halfValue) starClass += ' half';

                    html += `<span class="${starClass}" onclick="setEntryRating('${cat}', event, ${star})">‚òÖ</span>`;
                }
                c.innerHTML = html;
            });
            updateEntryCalculatedRating();
        }

        function setEntryRating(cat, event, star) {
            const rect = event.target.getBoundingClientRect();
            const isHalf = (event.clientX - rect.left) < (rect.width / 2);
            const value = isHalf ? (star * 2 - 1) : (star * 2);

            entryRatings[cat] = value;
            renderEntryStars();
        }

        function updateEntryCalculatedRating() {
            const values = Object.values(entryRatings).filter(v => v > 0);
            const calcEl = document.getElementById('calculated-rating');

            if (values.length === 0 || !calcEl) {
                if (calcEl) calcEl.innerHTML = '<span class="text-xs text-zinc-500">‚Äî</span>';
                return;
            }

            const avg = values.reduce((a, b) => a + b, 0) / values.length;
            const rounded = Math.round(avg);
            const displayVal = (avg / 2).toFixed(1);
            const fullStars = Math.floor(rounded / 2);
            const hasHalf = rounded % 2 === 1;
            const labels = { 10: 'Masterpiece', 9: 'Excellent', 8: 'Great', 7: 'Good', 6: 'Decent', 5: 'Average', 4: 'Below Avg', 3: 'Poor', 2: 'Bad', 1: 'Terrible' };

            let starsHtml = '';
            for (let i = 0; i < fullStars; i++) starsHtml += '<i class="fa-solid fa-star text-amber-400"></i>';
            if (hasHalf) starsHtml += '<i class="fa-solid fa-star-half-stroke text-amber-400"></i>';

            calcEl.innerHTML = `${starsHtml}<span class="ml-1 text-amber-400 font-medium text-xs">${displayVal}/5</span>${labels[rounded] ? `<span class="ml-1 text-[9px] text-zinc-400">${labels[rounded]}</span>` : ''}`;
        }
        async function submitEntry() {
            const gameId = document.getElementById('entry-game').value;
            if (!gameId) { toast('Select game', 'error'); return; }

            const hours = parseInt(document.getElementById('entry-hours').value) || 0;
            const mins = parseInt(document.getElementById('entry-mins').value) || 0;
            const sessionMinutes = hours * 60 + mins;

            const entry = {
                gameId,
                date: document.getElementById('entry-date').value,
                sessionStatus: document.getElementById('entry-status').value,
                sessionMinutes: sessionMinutes > 0 ? sessionMinutes : null,
                thoughts: document.getElementById('entry-thoughts').value,
                discoveries: document.getElementById('entry-discoveries').value,
                ratings: { ...entryRatings },
                createdAt: new Date().toISOString()
            };

            const res = await fetch(`${API}?action=add-journal-entry`, { method: 'POST', credentials: 'include', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(entry) });
            if ((await res.json()).success) {
                user.journalEntries = user.journalEntries || [];
                user.journalEntries.push(entry);
                closeEntryModal();
                renderJournal();
                render();
                toast('Saved');
            } else {
                toast('Failed', 'error');
            }
        }

        // Edit existing journal entry
        let editingEntryIndex = null;

        function editJournalEntry(idx) {
            const entry = user.journalEntries[idx];
            if (!entry) return;

            editingEntryIndex = idx;
            const game = (user.games || []).find(g => g.steamAppId == entry.gameId || g.id == entry.gameId);

            // Populate modal
            document.getElementById('entry-game').value = entry.gameId;
            document.getElementById('entry-game-search').value = '';
            document.getElementById('entry-game-list').classList.add('hidden');

            if (game) {
                document.getElementById('entry-game-selected').classList.remove('hidden');
                document.getElementById('entry-game-icon').src = game.icon || game.headerImg;
                document.getElementById('entry-game-name').textContent = game.name;
            }

            // Set date
            const entryDate = entry.date || (entry.endTime ? entry.endTime.split('T')[0] : '');
            document.getElementById('entry-date').value = entryDate;

            // Set duration
            if (entry.sessionMinutes) {
                document.getElementById('entry-hours').value = Math.floor(entry.sessionMinutes / 60) || '';
                document.getElementById('entry-mins').value = entry.sessionMinutes % 60 || '';
            } else {
                document.getElementById('entry-hours').value = '';
                document.getElementById('entry-mins').value = '';
            }

            document.getElementById('entry-status').value = entry.sessionStatus || 'playing';
            document.getElementById('entry-thoughts').value = entry.thoughts || entry.notes || '';
            document.getElementById('entry-discoveries').value = entry.discoveries || '';

            // Set ratings
            entryRatings = entry.ratings || { story: 0, gameplay: 0, graphics: 0, audio: 0 };
            renderEntryStars();

            document.getElementById('entry-submit-text').textContent = 'Update Entry';
            document.getElementById('entry-modal').classList.remove('hidden');
        }

        async function updateJournalEntry() {
            if (editingEntryIndex === null) return submitEntry(); // Fallback to create

            const hours = parseInt(document.getElementById('entry-hours').value) || 0;
            const mins = parseInt(document.getElementById('entry-mins').value) || 0;
            const sessionMinutes = hours * 60 + mins;

            const updatedEntry = {
                ...user.journalEntries[editingEntryIndex],
                date: document.getElementById('entry-date').value,
                sessionStatus: document.getElementById('entry-status').value,
                sessionMinutes: sessionMinutes > 0 ? sessionMinutes : null,
                thoughts: document.getElementById('entry-thoughts').value,
                discoveries: document.getElementById('entry-discoveries').value,
                ratings: { ...entryRatings },
                updatedAt: new Date().toISOString()
            };

            user.journalEntries[editingEntryIndex] = updatedEntry;

            const res = await fetch(`${API}?action=update-journal-entry`, {
                method: 'POST',
                credentials: 'include',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ index: editingEntryIndex, entry: updatedEntry })
            });

            if ((await res.json()).success) {
                editingEntryIndex = null;
                closeEntryModal();
                renderJournal();
                toast('Updated');
            } else {
                toast('Failed to update', 'error');
            }
        }

        // Search Modal
        function openSearchModal() { document.getElementById('search-modal').classList.remove('hidden'); document.getElementById('search-query').focus(); document.getElementById('search-empty').classList.remove('hidden'); }
        function closeSearchModal() { document.getElementById('search-modal').classList.add('hidden'); }
        function setPlatform(p) { searchPlatform = p; document.querySelectorAll('[id^="sp-"]').forEach(b => b.classList.remove('active')); document.getElementById(`sp-${p}`).classList.add('active'); doSearch(); }
        function debounceSearch() { clearTimeout(searchTimeout); searchTimeout = setTimeout(doSearch, 400); }
        async function doSearch() {
            const q = document.getElementById('search-query').value.trim();
            if (q.length < 2) { document.getElementById('search-results').innerHTML = ''; document.getElementById('search-empty').classList.remove('hidden'); return; }
            document.getElementById('search-empty').classList.add('hidden');
            document.getElementById('search-loading').classList.remove('hidden');
            try {
                const res = await fetch(`${API}?action=search-games&query=${encodeURIComponent(q)}&platform=${searchPlatform}`, { credentials: 'include' });
                const data = await res.json();
                document.getElementById('search-loading').classList.add('hidden');
                if (!data.games?.length) { document.getElementById('search-results').innerHTML = '<p class="text-center text-zinc-500 py-8">No results</p>'; return; }
                document.getElementById('search-results').innerHTML = data.games.map(g => {
                    const owned = user?.games?.find(ug => ug.name.toLowerCase() === g.name.toLowerCase());
                    const wishlisted = (user?.wishlist || []).find(w => w.id === g.id);

                    // Status badges
                    let statusBadge = '';
                    if (owned) statusBadge = '<span class="text-xs px-2 py-1 rounded-full bg-green-500/10 text-green-400"><i class="fa-solid fa-check mr-1"></i>Owned</span>';
                    else if (wishlisted) statusBadge = '<span class="text-xs px-2 py-1 rounded-full bg-pink-500/10 text-pink-400"><i class="fa-solid fa-heart mr-1"></i>Wishlisted</span>';

                    // Genres
                    const genres = (g.genres || []).slice(0, 3).map(gen => gen.name || gen).join(', ');

                    // Metacritic badge
                    const mcBadge = g.metacritic ? `<span class="text-xs px-1.5 py-0.5 rounded ${g.metacritic >= 75 ? 'bg-green-500/20 text-green-400' : g.metacritic >= 50 ? 'bg-yellow-500/20 text-yellow-400' : 'bg-red-500/20 text-red-400'}">MC ${g.metacritic}</span>` : '';

                    // Action buttons - only show appropriate ones
                    const gameData = encodeURIComponent(JSON.stringify(g));
                    let actions = '';
                    if (!owned) {
                        actions += `<button onclick="event.stopPropagation();addGameFromSearch(decodeURIComponent('${gameData}'))" class="px-2 py-1 bg-green-500/10 hover:bg-green-500/20 text-green-400 rounded text-[10px] transition"><i class="fa-solid fa-plus mr-1"></i>Library</button>`;
                    }
                    if (!wishlisted && !owned) {
                        actions += `<button onclick="event.stopPropagation();addToWishlistFromSearch(decodeURIComponent('${gameData}'))" class="px-2 py-1 bg-pink-500/10 hover:bg-pink-500/20 text-pink-400 rounded text-[10px] transition"><i class="fa-solid fa-heart mr-1"></i>Wishlist</button>`;
                    }
                    if (owned) {
                        actions += `<button onclick="event.stopPropagation();quickJournalFromSearch('${owned.steamAppId || owned.id}')" class="px-2 py-1 bg-violet-500/10 hover:bg-violet-500/20 text-violet-400 rounded text-[10px] transition"><i class="fa-solid fa-book mr-1"></i>Journal</button>`;
                    }

                    return `<div class="p-3 rounded-lg hover:bg-white/5 border border-white/5 mb-2">
                <div class="flex items-start gap-3">
                    <img src="${g.background_image || ''}" class="w-20 h-14 rounded-lg object-cover bg-zinc-800 flex-shrink-0">
                    <div class="flex-1 min-w-0">
                        <div class="flex items-center gap-2 mb-1">
                            <div class="font-medium text-sm truncate">${g.name}</div>
                            ${mcBadge}
                        </div>
                        <div class="text-xs text-zinc-500 mb-1">${g.released || 'TBA'} ${g.rating ? '¬∑ ‚≠ê' + g.rating.toFixed(1) : ''}</div>
                        ${genres ? `<div class="text-[10px] text-zinc-600 mb-2">${genres}</div>` : ''}
                        <div class="flex items-center gap-2 flex-wrap">
                            ${statusBadge}
                            ${actions}
                        </div>
                    </div>
                </div>
            </div>`;
                }).join('');
            } catch (e) { document.getElementById('search-loading').classList.add('hidden'); }
        }

        async function addGameFromSearch(gameDataStr) {
            const g = JSON.parse(gameDataStr);
            const res = await fetch(`${API}?action=add-manual-game`, {
                method: 'POST',
                credentials: 'include',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ name: g.name, platform: 'pc', status: 'backlog', imageUrl: g.background_image })
            });
            if ((await res.json()).success) {
                const me = await (await fetch(`${API}?action=me`, { credentials: 'include' })).json();
                user = me.user;
                doSearch();
                render();
                toast('Added to library');
            }
        }

        async function addToWishlistFromSearch(gameDataStr) {
            const g = JSON.parse(gameDataStr);
            await addToWishlist({
                id: g.id,
                name: g.name,
                imageUrl: g.background_image,
                rawgData: g
            });
            doSearch();
            toast('Added to wishlist');
        }

        function quickJournalFromSearch(gameId) {
            closeSearchModal();
            openEntryModal();
            setTimeout(() => {
                const game = (user.games || []).find(g => (g.steamAppId || g.id) == gameId);
                if (game) {
                    document.getElementById('entry-game').value = gameId;
                    document.getElementById('entry-game-selected').classList.remove('hidden');
                    document.getElementById('entry-game-icon').src = game.icon || game.headerImg;
                    document.getElementById('entry-game-name').textContent = game.name;
                }
            }, 100);
        }

        // Settings Modal
        function openSettingsModal() {
            document.getElementById('set-username').value = user.username || '';
            document.getElementById('current-username').textContent = user.username || 'not set';
            const hidden = (user.games || []).filter(g => g.hidden);
            document.getElementById('hidden-games-list').innerHTML = hidden.length ? hidden.map(g => `<div class="flex items-center justify-between p-2 rounded bg-white/5"><span class="text-sm truncate">${g.name}</span><button onclick="unhideGame('${g.steamAppId || g.id}')" class="text-xs text-violet-400">Unhide</button></div>`).join('') : '<p class="text-zinc-500 text-sm">No hidden games</p>';
            // Steam status
            const steamEl = document.getElementById('steam-status');
            const steamUnlink = document.getElementById('steam-unlink');
            if (user.steam?.id) {
                steamEl.innerHTML = `
                    <div class="flex items-center justify-between">
                        <span class="text-sm text-green-400"><i class="fa-solid fa-check mr-2"></i>Connected</span>
                        <span class="text-xs text-zinc-400">${user.steam.personaName || 'Steam User'}</span>
                    </div>
                    <div class="text-xs text-zinc-500 mt-1">
                        ${user.steam.gameCount || 0} games ¬∑ Last sync: ${user.steam.lastSync ? formatTimeAgo(new Date(user.steam.lastSync)) : 'Never'}
                    </div>
                `;
                steamUnlink?.classList.remove('hidden');
            } else {
                steamEl.innerHTML = `
                    <div class="text-sm text-zinc-400 mb-3">Not connected</div>
                    <div class="flex gap-2">
                        <input type="text" id="steam-link-input" placeholder="Steam ID or profile URL" class="flex-1 bg-white/5 border border-white/10 rounded-lg px-3 py-2 text-sm focus:outline-none focus:border-violet-500/50">
                        <button onclick="linkSteam()" class="bg-[#1b2838] hover:bg-[#2a475e] text-[#66c0f4] px-4 py-2 rounded-lg text-sm font-medium flex items-center gap-2">
                            <i class="fa-brands fa-steam"></i> Link
                        </button>
                    </div>
                    <p class="text-xs text-zinc-600 mt-2">Paste your Steam profile URL or 17-digit Steam ID</p>
                `;
                steamUnlink?.classList.add('hidden');
            }
            document.getElementById('settings-modal').classList.remove('hidden');
        }

        async function linkSteam() {
            const steamId = document.getElementById('steam-link-input').value.trim();
            if (!steamId) { toast('Please enter Steam ID or URL', 'error'); return; }

            const res = await fetch(`${API}?action=link-steam`, {
                method: 'POST',
                credentials: 'include',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ steamId })
            });
            const data = await res.json();

            if (data.error) {
                toast(data.error, 'error');
            } else {
                toast('Steam linked! Syncing games...');
                // Refresh user data
                const me = await (await fetch(`${API}?action=me`, { credentials: 'include' })).json();
                user = me.user;
                render();
                openSettingsModal();
            }
        }

        function closeSettingsModal() { document.getElementById('settings-modal').classList.add('hidden'); }
        async function saveUsername() {
            const u = document.getElementById('set-username').value.trim().toLowerCase();
            const res = await fetch(`${API}?action=set-username`, { method: 'POST', credentials: 'include', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ username: u }) });
            const data = await res.json();
            if (data.error) toast(data.error, 'error'); else { location.href = `/game-logger/${data.username}`; }
        }
        async function unhideGame(id) {
            await fetch(`${API}?action=toggle-hidden`, { method: 'POST', credentials: 'include', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ steamAppId: id, hidden: false }) });
            const i = (user.games || []).findIndex(g => g.steamAppId == id || g.id == id); if (i > -1) user.games[i].hidden = false;
            openSettingsModal(); render(); toast('Unhidden');
        }
        async function unlinkSteam() {
            if (!confirm('‚ö†Ô∏è This will permanently delete ALL your game data, journal entries, and wishlist. This cannot be undone.\n\nAre you sure you want to unlink Steam?')) return;
            if (!confirm('Final confirmation: Type "UNLINK" mentally and click OK to proceed.')) return;

            try {
                const res = await fetch(`${API}?action=unlink-steam`, { method: 'POST', credentials: 'include' });
                const data = await res.json();
                if (data.success) {
                    toast('Steam unlinked - redirecting...');
                    setTimeout(() => location.href = '/game-logger/', 1500);
                } else {
                    toast(data.error || 'Failed to unlink', 'error');
                }
            } catch (e) {
                toast('Failed to unlink Steam', 'error');
            }
        }
        async function clearJournal() { if (!confirm('Clear all journal entries?')) return; user.journalEntries = []; await fetch(`${API}?action=clear-journal`, { method: 'POST', credentials: 'include' }); render(); toast('Cleared'); }
        async function clearWishlist() { if (!confirm('Clear entire wishlist?')) return; user.wishlist = []; await fetch(`${API}?action=clear-wishlist`, { method: 'POST', credentials: 'include' }); renderWishlist(); toast('Wishlist cleared'); }

        // Add Game Modal
        let addGameStatus = 'backlog';
        let addGameRating = 0;
        function openAddGame() {
            document.getElementById('ag-name').value = '';
            document.getElementById('ag-hours').value = '';
            addGameStatus = 'backlog';
            addGameRating = 0;
            renderAddGameStatus();
            renderAddGameRating();
            document.getElementById('add-game-modal').classList.remove('hidden');
        }
        function closeAddGame() { document.getElementById('add-game-modal').classList.add('hidden'); }
        function setAddGameStatus(s) { addGameStatus = s; renderAddGameStatus(); }
        function renderAddGameStatus() {
            document.querySelectorAll('.ag-status-btn').forEach(b => {
                b.classList.toggle('btn-glow', b.dataset.status === addGameStatus);
                b.classList.toggle('bg-white/5', b.dataset.status !== addGameStatus);
                b.classList.toggle('text-white', b.dataset.status === addGameStatus);
                b.classList.toggle('text-zinc-400', b.dataset.status !== addGameStatus);
            });
        }
        function renderAddGameRating() {
            document.getElementById('ag-rating').innerHTML = Array.from({ length: 10 }, (_, i) =>
                `<button type="button" onclick="setAddGameRating(${i + 1})" class="text-lg transition ${i < addGameRating ? 'text-amber-400' : 'text-zinc-700'} hover:text-amber-300">‚òÖ</button>`
            ).join('');
        }
        function setAddGameRating(r) { addGameRating = r; renderAddGameRating(); }
        async function submitAddGame() {
            const name = document.getElementById('ag-name').value.trim(); if (!name) { toast('Enter name', 'error'); return; }
            const res = await fetch(`${API}?action=add-manual-game`, { method: 'POST', credentials: 'include', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ name, platform: document.getElementById('ag-platform').value, playtimeMinutes: (parseInt(document.getElementById('ag-hours').value) || 0) * 60, status: addGameStatus, rating: addGameRating || null }) });
            if ((await res.json()).success) { const me = await (await fetch(`${API}?action=me`, { credentials: 'include' })).json(); user = me.user; closeAddGame(); render(); toast('Added'); } else { toast('Failed', 'error'); }
        }

        // Wishlist
        function renderWishlist() {
            const wishlist = (user.wishlist || []).slice().sort((a, b) => {
                // Sort by priority first (higher first), then by release date
                const pa = a.wishlistPriority || 0;
                const pb = b.wishlistPriority || 0;
                if (pb !== pa) return pb - pa;
                return (a.released || 'z').localeCompare(b.released || 'z');
            });

            if (!wishlist.length) {
                document.getElementById('wishlist-grid').innerHTML = '';
                document.getElementById('no-wishlist').classList.remove('hidden');
                return;
            }
            document.getElementById('no-wishlist').classList.add('hidden');

            document.getElementById('wishlist-grid').innerHTML = wishlist.map(g => {
                const priorityBadge = g.wishlistPriority === 3 ? '<span class="absolute top-2 left-2 px-2 py-0.5 rounded text-[10px] bg-red-500/80 text-white">üî• HIGH</span>'
                    : g.wishlistPriority === 2 ? '<span class="absolute top-2 left-2 px-2 py-0.5 rounded text-[10px] bg-amber-500/80 text-white">‚ö° MED</span>'
                        : g.wishlistPriority === 1 ? '<span class="absolute top-2 left-2 px-2 py-0.5 rounded text-[10px] bg-blue-500/80 text-white">üí§ LOW</span>'
                            : '';

                const notesBadge = g.wishlistNotes ? '<span class="absolute top-2 right-10 w-6 h-6 rounded-full bg-black/60 text-violet-400 flex items-center justify-center text-xs" title="Has notes"><i class="fa-solid fa-sticky-note"></i></span>' : '';

                // Release date badge
                let releaseBadge = '';
                if (g.released) {
                    const releaseDate = new Date(g.released);
                    const now = new Date();
                    if (releaseDate > now) {
                        const days = Math.ceil((releaseDate - now) / (1000 * 60 * 60 * 24));
                        releaseBadge = days <= 30 ? `<span class="text-green-400 text-xs">üöÄ ${days}d</span>` : '';
                    }
                }

                return `<div class="group relative rounded-xl overflow-hidden cursor-pointer border border-white/5 hover:border-violet-500/30 transition" onclick="openWishlistItem(${JSON.stringify(g).replace(/"/g, '&quot;')})">
                    <img src="${g.background_image || ''}" class="w-full h-32 object-cover">
                    <div class="absolute inset-0 bg-gradient-to-t from-black/90 via-black/40 to-transparent"></div>
                    ${priorityBadge}
                    ${notesBadge}
                    <div class="absolute bottom-0 left-0 right-0 p-3">
                        <div class="font-medium text-sm truncate">${g.name}</div>
                        <div class="flex items-center gap-2 text-xs text-zinc-400">
                            <span>${g.released || 'TBA'}</span>
                            ${releaseBadge}
                            ${g.metacritic ? `<span class="text-green-400">${g.metacritic}</span>` : ''}
                        </div>
                    </div>
                    ${isOwner ? `<button onclick="event.stopPropagation();removeFromWishlist('${g.id}')" class="absolute top-2 right-2 w-7 h-7 rounded-full bg-black/60 text-red-400 opacity-0 group-hover:opacity-100 transition flex items-center justify-center"><i class="fa-solid fa-xmark text-xs"></i></button>` : ''}
                </div>`;
            }).join('');
        }
        async function addToWishlist(g) {
            user.wishlist = user.wishlist || [];
            if (user.wishlist.find(w => w.id === g.id)) { toast('Already in wishlist'); return; }
            // Mark as manually added so it doesn't get removed during Steam sync
            const wishlistItem = { ...g, manuallyAdded: true, addedAt: new Date().toISOString() };
            user.wishlist.push(wishlistItem);
            await fetch(`${API}?action=add-to-wishlist`, { method: 'POST', credentials: 'include', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(wishlistItem) });
            toast('Added to wishlist');
            closeGamePreview();
        }
        async function removeFromWishlist(id) {
            user.wishlist = (user.wishlist || []).filter(g => g.id != id);
            await fetch(`${API}?action=remove-from-wishlist`, { method: 'POST', credentials: 'include', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ id }) });
            renderWishlist();
            toast('Removed');
        }

        // Wishlist item editing
        let currentWishlistItem = null;

        function openWishlistItem(g) {
            currentWishlistItem = g;

            // Create and show modal
            const modal = document.createElement('div');
            modal.id = 'wishlist-item-modal';
            modal.className = 'fixed inset-0 z-50 flex items-center justify-center p-4';
            modal.onclick = (e) => { if (e.target === modal) closeWishlistItemModal(); };

            const priority = g.wishlistPriority || 0;

            modal.innerHTML = `
                <div class="modal-overlay absolute inset-0"></div>
                <div class="modal-card relative w-full max-w-md p-6">
                    <button onclick="closeWishlistItemModal()" class="absolute top-4 right-4 text-zinc-400 hover:text-white"><i class="fa-solid fa-xmark"></i></button>
                    
                    <div class="flex items-center gap-4 mb-5">
                        <img src="${g.background_image || ''}" class="w-16 h-16 rounded-lg object-cover">
                        <div>
                            <h3 class="font-bold text-lg">${g.name}</h3>
                            <div class="text-sm text-zinc-400">${g.released || 'TBA'}${g.metacritic ? ' ¬∑ Metacritic: ' + g.metacritic : ''}</div>
                        </div>
                    </div>
                    
                    <div class="space-y-4">
                        <div>
                            <label class="text-xs text-zinc-500 uppercase mb-2 block">Priority</label>
                            <div class="flex gap-2">
                                <button onclick="setWishlistPriority(3)" class="wl-priority-btn flex-1 py-2 rounded-lg text-sm transition ${priority === 3 ? 'bg-red-500/30 text-red-300 border-2 border-red-500' : 'bg-white/5 text-zinc-400 border border-transparent hover:border-red-500/50'}" data-priority="3">üî• High</button>
                                <button onclick="setWishlistPriority(2)" class="wl-priority-btn flex-1 py-2 rounded-lg text-sm transition ${priority === 2 ? 'bg-amber-500/30 text-amber-300 border-2 border-amber-500' : 'bg-white/5 text-zinc-400 border border-transparent hover:border-amber-500/50'}" data-priority="2">‚ö° Med</button>
                                <button onclick="setWishlistPriority(1)" class="wl-priority-btn flex-1 py-2 rounded-lg text-sm transition ${priority === 1 ? 'bg-blue-500/30 text-blue-300 border-2 border-blue-500' : 'bg-white/5 text-zinc-400 border border-transparent hover:border-blue-500/50'}" data-priority="1">üí§ Low</button>
                            </div>
                        </div>
                        
                        <div>
                            <label class="text-xs text-zinc-500 uppercase mb-2 block">Notes</label>
                            <textarea id="wl-notes" class="w-full h-20 resize-none" placeholder="Why do you want this game?">${g.wishlistNotes || ''}</textarea>
                        </div>
                    </div>
                    
                    <div class="flex gap-3 mt-6">
                        <button onclick="closeWishlistItemModal()" class="flex-1 py-2.5 rounded-lg bg-white/5 hover:bg-white/10 transition">Close</button>
                        <button onclick="saveWishlistItem()" class="flex-1 py-2.5 rounded-lg btn-glow font-medium">
                            <i class="fa-solid fa-check mr-2"></i>Save
                        </button>
                    </div>
                </div>
            `;

            document.body.appendChild(modal);
        }

        function closeWishlistItemModal() {
            document.getElementById('wishlist-item-modal')?.remove();
            currentWishlistItem = null;
        }

        function setWishlistPriority(priority) {
            if (!currentWishlistItem) return;
            currentWishlistItem.wishlistPriority = priority;

            // Update button styles
            document.querySelectorAll('.wl-priority-btn').forEach(btn => {
                const p = parseInt(btn.dataset.priority);
                const colors = { 3: 'red', 2: 'amber', 1: 'blue' };
                const color = colors[p];

                if (p === priority) {
                    btn.className = `wl-priority-btn flex-1 py-2 rounded-lg text-sm transition bg-${color}-500/30 text-${color}-300 border-2 border-${color}-500`;
                } else {
                    btn.className = `wl-priority-btn flex-1 py-2 rounded-lg text-sm transition bg-white/5 text-zinc-400 border border-transparent hover:border-${color}-500/50`;
                }
            });
        }

        async function saveWishlistItem() {
            if (!currentWishlistItem) return;

            const notes = document.getElementById('wl-notes').value.trim();
            const idx = (user.wishlist || []).findIndex(w => w.id === currentWishlistItem.id);

            if (idx > -1) {
                user.wishlist[idx].wishlistPriority = currentWishlistItem.wishlistPriority;
                user.wishlist[idx].wishlistNotes = notes;

                await fetch(`${API}?action=update-wishlist-item`, {
                    method: 'POST',
                    credentials: 'include',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ id: currentWishlistItem.id, wishlistPriority: currentWishlistItem.wishlistPriority, wishlistNotes: notes })
                });
            }

            closeWishlistItemModal();
            renderWishlist();
            toast('Wishlist item updated');
        }

        // ========== COLLECTIONS ==========
        let editingCollectionId = null;
        let collectionColor = 'violet';
        let collectionSelectedGames = [];

        function renderCollections() {
            const collections = user.collections || [];
            if (!collections.length) {
                document.getElementById('collections-grid').innerHTML = '';
                document.getElementById('no-collections').classList.remove('hidden');
                return;
            }
            document.getElementById('no-collections').classList.add('hidden');

            document.getElementById('collections-grid').innerHTML = collections.map((c, idx) => {
                const games = (c.gameIds || []).map(id => (user.games || []).find(g => g.steamAppId == id || g.id == id)).filter(Boolean);
                const covers = games.slice(0, 4);
                const colorClass = `bg-${c.color || 'violet'}-500`;

                return `<div class="group relative rounded-xl overflow-hidden bg-white/5 hover:bg-white/10 transition cursor-pointer border border-white/5 hover:border-${c.color || 'violet'}-500/30" onclick="openCollectionDetail(${idx})">
                    <div class="flex h-24">
                        ${covers.length ? covers.map(g => `<div class="flex-1 h-full"><img src="${g.headerImg || g.icon}" class="w-full h-full object-cover"></div>`).join('') : `<div class="flex-1 h-full flex items-center justify-center text-zinc-600"><i class="fa-solid fa-folder text-3xl"></i></div>`}
                    </div>
                    <div class="p-4">
                        <div class="flex items-center gap-2 mb-1">
                            <div class="w-2 h-2 rounded-full ${colorClass}"></div>
                            <span class="font-semibold">${c.name}</span>
                        </div>
                        <div class="text-xs text-zinc-500">${games.length} games${c.description ? ' ¬∑ ' + c.description.substring(0, 30) + (c.description.length > 30 ? '...' : '') : ''}</div>
                    </div>
                    ${isOwner ? `<div class="absolute top-2 right-2 flex gap-1 opacity-0 group-hover:opacity-100 transition">
                        <button onclick="event.stopPropagation();editCollection(${idx})" class="w-7 h-7 rounded-full bg-black/60 text-zinc-400 hover:text-white flex items-center justify-center"><i class="fa-solid fa-pencil text-xs"></i></button>
                        <button onclick="event.stopPropagation();deleteCollection(${idx})" class="w-7 h-7 rounded-full bg-black/60 text-red-400 hover:text-red-300 flex items-center justify-center"><i class="fa-solid fa-trash text-xs"></i></button>
                    </div>` : ''}
                </div>`;
            }).join('');
        }

        function openCollectionModal(existingIdx = null) {
            editingCollectionId = existingIdx;
            collectionSelectedGames = [];
            collectionColor = 'violet';

            if (existingIdx !== null && user.collections?.[existingIdx]) {
                const c = user.collections[existingIdx];
                document.getElementById('collection-name').value = c.name || '';
                document.getElementById('collection-desc').value = c.description || '';
                collectionColor = c.color || 'violet';
                collectionSelectedGames = [...(c.gameIds || [])];
                document.getElementById('collection-modal-title').textContent = 'Edit Collection';
            } else {
                document.getElementById('collection-name').value = '';
                document.getElementById('collection-desc').value = '';
                document.getElementById('collection-modal-title').textContent = 'New Collection';
            }

            setCollectionColor(collectionColor);
            filterCollectionGames();
            updateCollectionSelected();
            document.getElementById('collection-modal').classList.remove('hidden');
        }

        function closeCollectionModal() {
            document.getElementById('collection-modal').classList.add('hidden');
        }

        function editCollection(idx) {
            openCollectionModal(idx);
        }

        function setCollectionColor(color) {
            collectionColor = color;
            document.querySelectorAll('#collection-colors button').forEach(btn => {
                btn.classList.remove('ring-2', 'ring-offset-2', 'ring-offset-zinc-900');
                btn.classList.remove('ring-violet-500', 'ring-pink-500', 'ring-blue-500', 'ring-green-500', 'ring-amber-500', 'ring-red-500', 'ring-cyan-500');
            });
            const activeBtn = document.querySelector(`#collection-colors button[onclick*="${color}"]`);
            if (activeBtn) {
                activeBtn.classList.add('ring-2', `ring-${color}-500`, 'ring-offset-2', 'ring-offset-zinc-900');
            }
        }

        function filterCollectionGames() {
            const query = document.getElementById('collection-game-search').value.toLowerCase();
            const games = (user.games || []).filter(g => !g.hidden && g.name.toLowerCase().includes(query)).slice(0, 20);

            document.getElementById('collection-games-list').innerHTML = games.map(g => {
                const isSelected = collectionSelectedGames.includes(String(g.steamAppId || g.id));
                return `<div class="flex items-center gap-2 p-2 rounded-lg cursor-pointer hover:bg-white/5 ${isSelected ? 'bg-violet-500/10 border border-violet-500/30' : ''}" onclick="toggleCollectionGame('${g.steamAppId || g.id}')">
                    <img src="${g.icon || g.headerImg}" class="w-8 h-8 rounded object-cover">
                    <span class="text-sm flex-1 truncate">${g.name}</span>
                    ${isSelected ? '<i class="fa-solid fa-check text-violet-400"></i>' : ''}
                </div>`;
            }).join('');
        }

        function toggleCollectionGame(id) {
            const strId = String(id);
            if (collectionSelectedGames.includes(strId)) {
                collectionSelectedGames = collectionSelectedGames.filter(x => x !== strId);
            } else {
                collectionSelectedGames.push(strId);
            }
            filterCollectionGames();
            updateCollectionSelected();
        }

        function updateCollectionSelected() {
            document.getElementById('collection-count').textContent = collectionSelectedGames.length;
            const games = collectionSelectedGames.map(id => (user.games || []).find(g => String(g.steamAppId) === id || String(g.id) === id)).filter(Boolean);
            document.getElementById('collection-selected').innerHTML = games.length
                ? games.map(g => `<div class="flex items-center gap-1 px-2 py-1 rounded-full bg-white/10 text-xs">
                    <img src="${g.icon || g.headerImg}" class="w-4 h-4 rounded object-cover">
                    <span class="truncate max-w-[80px]">${g.name}</span>
                    <button onclick="toggleCollectionGame('${g.steamAppId || g.id}')" class="text-zinc-400 hover:text-red-400 ml-1"><i class="fa-solid fa-xmark text-[10px]"></i></button>
                </div>`).join('')
                : '<span class="text-xs text-zinc-500">No games selected</span>';
        }

        async function saveCollection() {
            const name = document.getElementById('collection-name').value.trim();
            if (!name) { toast('Please enter a name', 'error'); return; }

            user.collections = user.collections || [];

            const collection = {
                id: editingCollectionId !== null ? user.collections[editingCollectionId]?.id : `col_${Date.now()}`,
                name,
                description: document.getElementById('collection-desc').value.trim(),
                color: collectionColor,
                gameIds: collectionSelectedGames,
                createdAt: editingCollectionId !== null ? user.collections[editingCollectionId]?.createdAt : new Date().toISOString(),
                updatedAt: new Date().toISOString()
            };

            if (editingCollectionId !== null) {
                user.collections[editingCollectionId] = collection;
            } else {
                user.collections.push(collection);
            }

            await fetch(`${API}?action=save-collections`, { method: 'POST', credentials: 'include', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ collections: user.collections }) });

            closeCollectionModal();
            renderCollections();
            toast(editingCollectionId !== null ? 'Collection updated' : 'Collection created');
        }

        async function deleteCollection(idx) {
            if (!confirm('Delete this collection?')) return;
            user.collections.splice(idx, 1);
            await fetch(`${API}?action=save-collections`, { method: 'POST', credentials: 'include', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ collections: user.collections }) });
            renderCollections();
            toast('Collection deleted');
        }

        function openCollectionDetail(idx) {
            const c = user.collections?.[idx];
            if (!c) return;
            // For now, just filter library to show collection games
            filter = 'all';
            const gameIds = c.gameIds || [];
            // Store collection filter and re-render
            document.getElementById('search-input').value = '';
            switchView('library');
            // Custom filter - show only games in this collection
            const collectionGames = (user.games || []).filter(g => gameIds.includes(String(g.steamAppId || g.id)));
            // Update heading temporarily
            toast(`Viewing ${c.name} (${collectionGames.length} games)`);
        }

        // Game Preview Modal
        let previewGame = null;
        let previewOwnedGame = null; // Reference to owned game if exists

        function openGamePreview(g) {
            previewGame = g;
            document.getElementById('gp-bg').src = g.background_image || g.headerImg || '';
            document.getElementById('gp-title').textContent = g.name;
            document.getElementById('gp-meta').textContent = [g.released || '', g.rating ? `‚≠ê ${typeof g.rating === 'number' ? g.rating.toFixed(1) : g.rating}` : '', g.metacritic ? `MC: ${g.metacritic}` : ''].filter(Boolean).join(' ¬∑ ');

            const platforms = g.platforms || [];
            document.getElementById('gp-platforms').innerHTML = platforms.slice(0, 5).map(p => {
                const name = p.platform?.name || p.name || p;
                return `<span class="text-xs px-2 py-1 rounded bg-white/5 text-zinc-400">${typeof name === 'string' ? name.split(' ')[0] : ''}</span>`;
            }).join('');

            previewOwnedGame = user?.games?.find(ug => ug.name.toLowerCase() === g.name.toLowerCase());
            const wishlisted = (user?.wishlist || []).find(w => w.id === g.id);

            // Show/hide sections based on owned state
            document.getElementById('gp-owned').classList.toggle('hidden', !previewOwnedGame);
            document.getElementById('gp-wishlisted').classList.toggle('hidden', !wishlisted || previewOwnedGame);

            if (isOwner) {
                if (previewOwnedGame) {
                    // Show owned actions
                    document.getElementById('gp-add-actions').classList.add('hidden');
                    document.getElementById('gp-owned-actions').classList.remove('hidden');
                } else {
                    // Show add actions
                    document.getElementById('gp-add-actions').classList.remove('hidden');
                    document.getElementById('gp-owned-actions').classList.add('hidden');
                    document.getElementById('gp-wishlist-btn').classList.toggle('hidden', wishlisted);
                }
            } else {
                document.getElementById('gp-add-actions').classList.add('hidden');
                document.getElementById('gp-owned-actions').classList.add('hidden');
            }

            document.getElementById('game-preview-modal').classList.remove('hidden');
        }

        function closeGamePreview() {
            document.getElementById('game-preview-modal').classList.add('hidden');
            previewGame = null;
            previewOwnedGame = null;
        }

        async function addFromPreview() {
            if (!previewGame) return;
            const res = await fetch(`${API}?action=add-manual-game`, { method: 'POST', credentials: 'include', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ name: previewGame.name, platform: 'pc', status: 'backlog', imageUrl: previewGame.background_image }) });
            if ((await res.json()).success) { const me = await (await fetch(`${API}?action=me`, { credentials: 'include' })).json(); user = me.user; closeGamePreview(); doSearch(); render(); toast('Added to library'); }
        }

        function openEntryModalFor(g) {
            closeGamePreview();
            // Open journal entry modal with game pre-selected
            const game = previewOwnedGame || user?.games?.find(ug => ug.name.toLowerCase() === g.name.toLowerCase());
            if (game) {
                openEntryModal();
                document.getElementById('entry-game').value = game.steamAppId || game.id;
            }
        }

        function quickRate(g) {
            closeGamePreview();
            const game = previewOwnedGame || user?.games?.find(ug => ug.name.toLowerCase() === g.name.toLowerCase());
            if (game) openGameModal(game.steamAppId || game.id);
        }

        function quickStatus(g) {
            closeGamePreview();
            const game = previewOwnedGame || user?.games?.find(ug => ug.name.toLowerCase() === g.name.toLowerCase());
            if (game) openGameModal(game.steamAppId || game.id);
        }

        // Steam Sync
        async function syncSteam() {
            const btn = document.getElementById('sync-btn'); btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Syncing...'; btn.disabled = true;
            try { const res = await fetch(`${API}?action=sync-steam`, { method: 'POST', credentials: 'include' }); const data = await res.json(); if (data.error) toast(data.error, 'error'); else { toast(`Synced ${data.gameCount} games`); const me = await (await fetch(`${API}?action=me`, { credentials: 'include' })).json(); user = me.user; render(); } } catch (e) { toast('Failed', 'error'); }
            btn.innerHTML = '<i class="fa-brands fa-steam"></i> Sync Games'; btn.disabled = false;
        }

        async function syncSteamWishlist() {
            const btn = document.getElementById('sync-wishlist-btn');
            btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Syncing...';
            btn.disabled = true;
            try {
                const res = await fetch(`${API}?action=sync-steam-wishlist`, { method: 'POST', credentials: 'include' });
                const data = await res.json();
                if (data.error) {
                    toast(data.error, 'error');
                } else {
                    toast(`Synced ${data.count || 0} wishlist items`);
                    const me = await (await fetch(`${API}?action=me`, { credentials: 'include' })).json();
                    user = me.user;
                    renderWishlist();
                }
            } catch (e) {
                toast('Failed to sync wishlist', 'error');
            }
            btn.innerHTML = '<i class="fa-solid fa-heart"></i> Sync Wishlist';
            btn.disabled = false;
        }

        function toast(m, t = 'success') { const el = document.getElementById('toast'); el.innerHTML = `<i class="fa-solid ${t === 'error' ? 'fa-xmark text-red-400' : 'fa-check text-green-400'} mr-2"></i>${m}`; el.classList.remove('hidden'); setTimeout(() => el.classList.add('hidden'), 2500); }

        // === QoL: Keyboard Shortcuts ===
        let lastScrollPos = 0;
        document.addEventListener('keydown', e => {
            // Don't trigger if typing in an input
            if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA' || e.target.tagName === 'SELECT') {
                if (e.key === 'Escape') e.target.blur();
                return;
            }

            if (e.key === 'Escape') {
                closeGameModal(); closeEntryModal(); closeFavModal(); closeAddGame(); closeSearchModal(); closeSettingsModal(); closeGamePreview();
            }
            // / to focus search
            if (e.key === '/' && currentView === 'library') {
                e.preventDefault();
                document.getElementById('search-input').focus();
            }
            // G for grid, L for list, S for grouped
            if (e.key === 'g' || e.key === 'G') { setLibraryView('grid'); }
            if (e.key === 'l' || e.key === 'L') { setLibraryView('list'); }
            if (e.key === 's' || e.key === 'S') { setLibraryView('grouped'); }
        });

        // === QoL: Scroll Position Memory ===
        function saveScrollPos() { lastScrollPos = window.scrollY; }
        function restoreScrollPos() { setTimeout(() => window.scrollTo(0, lastScrollPos), 50); }

        // Override close functions to restore scroll
        const origCloseGame = closeGameModal;
        closeGameModal = function () { origCloseGame(); restoreScrollPos(); };

        // === QoL: Sync Indicator ===
        function updateSyncIndicator() {
            // Check both possible locations for lastSync
            const syncTime = user?.lastSync || user?.steam?.lastSync;
            if (!syncTime) return;

            document.getElementById('sync-indicator').classList.remove('hidden');

            const lastSyncTime = new Date(syncTime);
            const ago = formatTimeAgo(lastSyncTime);
            document.getElementById('last-sync').textContent = `Synced: ${ago}`;

            // Auto-sync runs hourly, calculate next sync
            const nextSync = new Date(lastSyncTime.getTime() + 60 * 60 * 1000);
            const remaining = nextSync - Date.now();
            if (remaining > 0) {
                const mins = Math.ceil(remaining / 60000);
                document.getElementById('next-sync').textContent = `Next: ${mins}m`;
            } else {
                document.getElementById('next-sync').textContent = 'Next: Soon';
            }
        }

        function formatTimeAgo(date) {
            const diff = Date.now() - date.getTime();
            const mins = Math.floor(diff / 60000);
            if (mins < 60) return `${mins}m ago`;
            const hours = Math.floor(mins / 60);
            if (hours < 24) return `${hours}h ago`;
            return `${Math.floor(hours / 24)}d ago`;
        }

        // === QoL: Game Count in Tabs ===
        function updateTabCounts() {
            const games = (user.games || []).filter(g => !g.hidden);
            const entries = (user.journalEntries || []).length;
            const wishlist = (user.wishlist || []).length;

            document.getElementById('tab-library').textContent = `Library (${games.length})`;
            document.getElementById('tab-journal').textContent = `Journal (${entries})`;
            document.getElementById('tab-wishlist').textContent = `Wishlist (${wishlist})`;

            // Also update nav
            document.getElementById('nav-library').innerHTML = `<i class="fa-solid fa-gamepad w-4"></i>Library (${games.length})`;
            document.getElementById('nav-journal').innerHTML = `<i class="fa-solid fa-book w-4"></i>Journal (${entries})`;
            document.getElementById('nav-wishlist').innerHTML = `<i class="fa-solid fa-heart w-4"></i>Wishlist (${wishlist})`;
        }

        // === QoL: Sticky Filters ===
        function loadStickyPrefs() {
            const savedFilter = localStorage.getItem('gl_filter');
            const savedSort = localStorage.getItem('gl_sort');
            const savedView = localStorage.getItem('libraryView');
            if (savedFilter) { filter = savedFilter; }
            if (savedSort) { document.getElementById('sort-select').value = savedSort; }
            if (savedView) { libraryView = savedView; }
        }

        function saveStickyPrefs() {
            localStorage.setItem('gl_filter', filter);
            localStorage.setItem('gl_sort', document.getElementById('sort-select').value);
        }

        // Override filter to save
        const origFilter = filterGames;
        filterGames = function (f) { origFilter(f); saveStickyPrefs(); };

        // Add save on sort change
        document.getElementById('sort-select')?.addEventListener('change', saveStickyPrefs);

        // === QoL: Double-click to Edit ===
        document.addEventListener('dblclick', e => {
            const row = e.target.closest('.game-row, .game-card');
            if (row) {
                const onclick = row.getAttribute('onclick');
                if (onclick) {
                    const match = onclick.match(/openGameModal\('([^']+)'\)/);
                    if (match) {
                        saveScrollPos();
                        openGameModal(match[1]);
                    }
                }
            }
        });

        // Update render to include new features
        const origRender = render;
        render = function () {
            origRender();
            updateTabCounts();
            updateSyncIndicator();
        };

        // === QoL: Export to JSON ===
        function exportLibrary() {
            const exportData = {
                exportDate: new Date().toISOString(),
                profile: {
                    username: user.username,
                    displayName: user.displayName,
                    avatar: user.avatar
                },
                games: (user.games || []).map(g => ({
                    name: g.name,
                    steamAppId: g.steamAppId,
                    status: g.status,
                    rating: g.rating,
                    playtimeMinutes: g.playtimeMinutes,
                    achievements: g.achievements,
                    platforms: g.platforms,
                    notes: g.notes,
                    completedAt: g.completedAt,
                    favorite: g.favorite,
                    hidden: g.hidden,
                    lastPlayed: g.lastPlayed
                })),
                journalEntries: user.journalEntries || [],
                wishlist: user.wishlist || [],
                stats: {
                    totalGames: (user.games || []).length,
                    totalHours: Math.round((user.games || []).reduce((s, g) => s + (g.playtimeMinutes || 0), 0) / 60),
                    perfected: (user.games || []).filter(g => g.status === 'perfected').length
                }
            };

            const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `game-library-${user.username || 'export'}-${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
            toast('Library exported!');
        }

        // === QoL: Right-Click Context Menu ===
        let contextMenuGame = null;
        document.addEventListener('contextmenu', e => {
            if (!isOwner) return;
            const row = e.target.closest('.game-row, .game-card');
            if (!row) return;

            e.preventDefault();
            const onclick = row.getAttribute('onclick');
            if (!onclick) return;
            const match = onclick.match(/openGameModal\('([^']+)'\)/);
            if (!match) return;

            const id = match[1];
            contextMenuGame = (user.games || []).find(x => x.steamAppId == id || x.id == id);
            if (!contextMenuGame) return;

            showContextMenu(e.clientX, e.clientY, id);
        });

        function showContextMenu(x, y, id) {
            // Remove existing context menu
            document.getElementById('game-context-menu')?.remove();

            const menu = document.createElement('div');
            menu.id = 'game-context-menu';
            menu.className = 'fixed z-[100] bg-[#1a1a24] border border-violet-500/30 rounded-lg shadow-xl py-2 min-w-[150px] text-sm';
            menu.style.left = x + 'px';
            menu.style.top = y + 'px';

            const g = contextMenuGame;
            menu.innerHTML = `
                <div class="px-3 py-1 text-xs text-zinc-500 font-medium truncate">${g.name}</div>
                <hr class="border-white/5 my-1">
                <button class="w-full px-3 py-2 text-left hover:bg-white/5 flex items-center gap-2" onclick="openGameModal('${id}');closeContextMenu()">
                    <i class="fa-solid fa-star text-amber-400 w-4"></i> Rate & Edit
                </button>
                <button class="w-full px-3 py-2 text-left hover:bg-white/5 flex items-center gap-2" onclick="openEntryModal();setTimeout(()=>document.getElementById('entry-game').value='${id}',50);closeContextMenu()">
                    <i class="fa-solid fa-book text-violet-400 w-4"></i> Add Journal Entry
                </button>
                <hr class="border-white/5 my-1">
                <div class="px-3 py-1 text-xs text-zinc-500">Set Status:</div>
                ${Object.entries(STATUSES).map(([k, v]) => `
                    <button class="w-full px-3 py-1.5 text-left hover:bg-white/5 text-xs ${g.status === k ? 'text-violet-400' : ''}" 
                        onclick="quickSetStatus('${id}','${k}');closeContextMenu()">${v}</button>
                `).join('')}
                <hr class="border-white/5 my-1">
                <button class="w-full px-3 py-2 text-left hover:bg-white/5 text-red-400 flex items-center gap-2" onclick="quickHide('${id}');closeContextMenu()">
                    <i class="fa-solid fa-eye-slash w-4"></i> ${g.hidden ? 'Unhide' : 'Hide'} Game
                </button>
            `;

            document.body.appendChild(menu);

            // Adjust if off-screen
            const rect = menu.getBoundingClientRect();
            if (rect.right > window.innerWidth) menu.style.left = (window.innerWidth - rect.width - 10) + 'px';
            if (rect.bottom > window.innerHeight) menu.style.top = (window.innerHeight - rect.height - 10) + 'px';
        }

        function closeContextMenu() {
            document.getElementById('game-context-menu')?.remove();
            contextMenuGame = null;
        }

        async function quickSetStatus(id, status) {
            const g = (user.games || []).find(x => x.steamAppId == id || x.id == id);
            if (!g) return;
            g.status = status;
            await saveGame(id, { status });
            renderGames();
            toast(`Status: ${STATUSES[status]}`);
        }

        async function quickHide(id) {
            const g = (user.games || []).find(x => x.steamAppId == id || x.id == id);
            if (!g) return;
            g.hidden = !g.hidden;
            await saveGame(id, { hidden: g.hidden });
            render();
            toast(g.hidden ? 'Game hidden' : 'Game unhidden');
        }

        // Close context menu on click elsewhere
        document.addEventListener('click', () => closeContextMenu());

        loadStickyPrefs();
        init();
    </script>
</body>

</html>